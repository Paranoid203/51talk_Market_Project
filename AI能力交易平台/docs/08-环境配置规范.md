# 环境配置规范文档

> **版本**: v1.0.0  
> **最后更新**: 2024-11-18

## 1. 概述

本文档定义了AI能力交易平台的环境配置规范，包括开发、测试、生产环境的配置管理和Docker容器化配置。

## 2. 环境分类

### 2.1 开发环境 (Development)

- **用途**: 本地开发
- **数据库**: 本地PostgreSQL或Docker容器
- **缓存**: 本地Redis或Docker容器
- **日志级别**: DEBUG
- **调试工具**: 启用

### 2.2 测试环境 (Testing)

- **用途**: 功能测试、集成测试
- **数据库**: 独立测试数据库
- **缓存**: 独立Redis实例
- **日志级别**: INFO
- **调试工具**: 部分启用

### 2.3 预发布环境 (Staging)

- **用途**: 发布前验证
- **数据库**: 类生产环境数据
- **缓存**: 独立Redis实例
- **日志级别**: INFO
- **调试工具**: 禁用

### 2.4 生产环境 (Production)

- **用途**: 线上服务
- **数据库**: 生产数据库集群
- **缓存**: Redis集群
- **日志级别**: WARN/ERROR
- **调试工具**: 禁用

## 3. 环境变量管理

### 3.1 环境变量文件

#### 前端 (.env)

```bash
# API地址
VITE_API_BASE_URL=http://localhost:3000/api/v1

# 环境标识
VITE_APP_ENV=development

# 功能开关
VITE_ENABLE_ANALYTICS=false
```

#### 后端 (.env)

```bash
# 应用配置
NODE_ENV=development
PORT=3000
APP_NAME=AI能力交易平台

# 数据库配置
DATABASE_URL=postgresql://user:password@localhost:5432/ai_platform_dev

# Redis配置
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# JWT配置
JWT_SECRET=your-secret-key-change-in-production
JWT_EXPIRES_IN=1h
JWT_REFRESH_SECRET=your-refresh-secret
JWT_REFRESH_EXPIRES_IN=7d

# 文件存储
STORAGE_TYPE=local
STORAGE_PATH=./uploads
# 或使用OSS
# OSS_ACCESS_KEY_ID=
# OSS_ACCESS_KEY_SECRET=
# OSS_BUCKET=
# OSS_REGION=

# 邮件配置
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_USER=
SMTP_PASSWORD=
SMTP_FROM=noreply@example.com

# 日志配置
LOG_LEVEL=debug
LOG_FILE=./logs/app.log

# 监控配置
SENTRY_DSN=
```

### 3.2 环境变量命名规范

- 使用大写字母和下划线
- 分组前缀（如 `DATABASE_`, `REDIS_`）
- 描述性命名

### 3.3 敏感信息处理

- **不提交**: `.env` 文件不提交到Git
- **示例文件**: 提供 `.env.example` 作为模板
- **加密存储**: 生产环境使用密钥管理服务
- **权限控制**: 限制环境变量访问权限

## 4. 配置文件管理

### 4.1 前端配置

#### Vite配置 (vite.config.ts)

```typescript
import { defineConfig, loadEnv } from 'vite';
import react from '@vitejs/plugin-react-swc';

export default defineConfig(({ mode }) => {
  const env = loadEnv(mode, process.cwd(), '');
  
  return {
    plugins: [react()],
    server: {
      port: parseInt(env.VITE_PORT || '5173'),
      proxy: {
        '/api': {
          target: env.VITE_API_BASE_URL,
          changeOrigin: true,
        },
      },
    },
    define: {
      'import.meta.env.VITE_APP_ENV': JSON.stringify(env.VITE_APP_ENV),
    },
  };
});
```

#### TypeScript配置 (tsconfig.json)

```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "ESNext",
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "jsx": "react-jsx",
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": ["src"],
  "exclude": ["node_modules", "dist"]
}
```

### 4.2 后端配置

#### NestJS配置 (config/app.config.ts)

```typescript
import { registerAs } from '@nestjs/config';

export default registerAs('app', () => ({
  port: parseInt(process.env.PORT, 10) || 3000,
  env: process.env.NODE_ENV || 'development',
  name: process.env.APP_NAME || 'AI能力交易平台',
  
  database: {
    url: process.env.DATABASE_URL,
  },
  
  redis: {
    host: process.env.REDIS_HOST || 'localhost',
    port: parseInt(process.env.REDIS_PORT, 10) || 6379,
    password: process.env.REDIS_PASSWORD,
  },
  
  jwt: {
    secret: process.env.JWT_SECRET,
    expiresIn: process.env.JWT_EXPIRES_IN || '1h',
    refreshSecret: process.env.JWT_REFRESH_SECRET,
    refreshExpiresIn: process.env.JWT_REFRESH_EXPIRES_IN || '7d',
  },
}));
```

#### 模块配置 (app.module.ts)

```typescript
import { ConfigModule } from '@nestjs/config';
import appConfig from './config/app.config';

@Module({
  imports: [
    ConfigModule.forRoot({
      isGlobal: true,
      load: [appConfig],
      envFilePath: ['.env.local', '.env'],
    }),
  ],
})
export class AppModule {}
```

## 5. Docker配置

### 5.1 Docker Compose (docker-compose.yml)

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    container_name: ai-platform-db
    environment:
      POSTGRES_USER: ${DB_USER:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
      POSTGRES_DB: ${DB_NAME:-ai_platform}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: ai-platform-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: ai-platform-backend
    environment:
      - NODE_ENV=development
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/ai_platform
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    ports:
      - "3000:3000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./backend:/app
      - /app/node_modules

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: ai-platform-frontend
    environment:
      - VITE_API_BASE_URL=http://localhost:3000/api/v1
    ports:
      - "5173:5173"
    volumes:
      - ./frontend:/app
      - /app/node_modules

volumes:
  postgres_data:
  redis_data:
```

### 5.2 Dockerfile示例

#### 后端 Dockerfile

```dockerfile
FROM node:20-alpine AS builder

WORKDIR /app

COPY package*.json ./
RUN npm ci

COPY . .
RUN npm run build

FROM node:20-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY --from=builder /app/dist ./dist
COPY --from=builder /app/prisma ./prisma

EXPOSE 3000

CMD ["node", "dist/main"]
```

#### 前端 Dockerfile

```dockerfile
FROM node:20-alpine AS builder

WORKDIR /app

COPY package*.json ./
RUN npm ci

COPY . .
RUN npm run build

FROM nginx:alpine

COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

## 6. 数据库环境配置

### 6.1 开发环境

- 使用Docker Compose启动
- 数据可随时重置
- 启用详细日志

### 6.2 测试环境

- 独立数据库实例
- 测试数据自动清理
- 数据隔离

### 6.3 生产环境

- 数据库集群
- 主从复制
- 自动备份
- 监控告警

## 7. 缓存环境配置

### 7.1 Redis配置

#### 开发环境

```bash
# redis.conf
maxmemory 256mb
maxmemory-policy allkeys-lru
```

#### 生产环境

```bash
# redis.conf
maxmemory 2gb
maxmemory-policy allkeys-lru
save 900 1
save 300 10
save 60 10000
```

## 8. 日志配置

### 8.1 日志级别

- **开发**: DEBUG
- **测试**: INFO
- **预发布**: INFO
- **生产**: WARN/ERROR

### 8.2 日志输出

- **开发**: 控制台输出
- **生产**: 文件 + 日志服务（如ELK）

## 9. 安全检查清单

- [ ] 敏感信息不提交到Git
- [ ] 生产环境使用密钥管理
- [ ] 环境变量权限控制
- [ ] 数据库连接加密
- [ ] API密钥定期轮换
- [ ] 日志不包含敏感信息

## 10. 检查清单

- [ ] 环境变量文件配置
- [ ] 配置文件管理规范
- [ ] Docker配置完善
- [ ] 数据库环境隔离
- [ ] 缓存环境配置
- [ ] 日志配置正确
- [ ] 安全检查通过

---

**相关文档**:
- [部署与CI-CD规范](./11-部署与CI-CD规范.md)
- [安全开发规范](./14-安全开发规范.md)

