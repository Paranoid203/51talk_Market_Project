# 测试规范文档

> **版本**: v1.0.0  
> **最后更新**: 2024-11-18

## 1. 概述

本文档定义了AI能力交易平台的测试规范，包括单元测试、集成测试、E2E测试的编写和执行标准。

## 2. 测试类型

### 2.1 单元测试（Unit Tests）

- **范围**: 单个函数、类、组件
- **目标**: 验证独立单元的功能
- **覆盖率要求**: ≥80%

### 2.2 集成测试（Integration Tests）

- **范围**: 多个模块协作
- **目标**: 验证模块间交互
- **覆盖率要求**: ≥60%

### 2.3 E2E测试（End-to-End Tests）

- **范围**: 完整用户流程
- **目标**: 验证端到端功能
- **覆盖率要求**: 核心流程100%

## 3. 测试工具

### 3.1 前端测试

- **测试框架**: Vitest / Jest
- **组件测试**: React Testing Library
- **E2E测试**: Playwright / Cypress
- **Mock**: MSW (Mock Service Worker)

### 3.2 后端测试

- **测试框架**: Jest
- **E2E测试**: Supertest
- **数据库**: 使用测试数据库
- **Mock**: jest.mock()

## 4. 测试文件组织

### 4.1 前端测试结构

```
src/
├── components/
│   ├── ToolMarketplace.tsx
│   └── ToolMarketplace.test.tsx
├── lib/
│   └── utils/
│       ├── format.ts
│       └── format.test.ts
└── __tests__/
    └── setup.ts
```

### 4.2 后端测试结构

```
test/
├── unit/
│   └── tools.service.spec.ts
├── integration/
│   └── tools.e2e-spec.ts
└── fixtures/
    └── tools.fixture.ts
```

## 5. 单元测试规范

### 5.1 测试命名

```typescript
describe('ToolsService', () => {
  describe('findAll', () => {
    it('should return an array of tools', () => {
      // ...
    });

    it('should filter tools by category', () => {
      // ...
    });
  });
});
```

### 5.2 测试结构（AAA模式）

```typescript
it('should create a tool', async () => {
  // Arrange - 准备
  const createToolDto = {
    name: 'Test Tool',
    description: 'Test Description',
  };

  // Act - 执行
  const result = await service.create(createToolDto);

  // Assert - 断言
  expect(result).toBeDefined();
  expect(result.name).toBe(createToolDto.name);
});
```

### 5.3 前端组件测试示例

```typescript
import { render, screen } from '@testing-library/react';
import { ToolMarketplace } from './ToolMarketplace';

describe('ToolMarketplace', () => {
  it('should render tool list', () => {
    render(<ToolMarketplace searchQuery="" />);
    
    expect(screen.getByText('工具广场')).toBeInTheDocument();
  });

  it('should filter tools by search query', () => {
    render(<ToolMarketplace searchQuery="AI" />);
    
    // 验证过滤结果
  });
});
```

### 5.4 后端服务测试示例

```typescript
import { Test } from '@nestjs/testing';
import { ToolsService } from './tools.service';
import { PrismaService } from '../prisma/prisma.service';

describe('ToolsService', () => {
  let service: ToolsService;
  let prisma: PrismaService;

  beforeEach(async () => {
    const module = await Test.createTestingModule({
      providers: [
        ToolsService,
        {
          provide: PrismaService,
          useValue: {
            tool: {
              findMany: jest.fn(),
              create: jest.fn(),
            },
          },
        },
      ],
    }).compile();

    service = module.get<ToolsService>(ToolsService);
    prisma = module.get<PrismaService>(PrismaService);
  });

  it('should be defined', () => {
    expect(service).toBeDefined();
  });

  describe('findAll', () => {
    it('should return an array of tools', async () => {
      const mockTools = [{ id: 1, name: 'Test Tool' }];
      jest.spyOn(prisma.tool, 'findMany').mockResolvedValue(mockTools);

      const result = await service.findAll({});

      expect(result).toEqual(mockTools);
      expect(prisma.tool.findMany).toHaveBeenCalled();
    });
  });
});
```

## 6. 集成测试规范

### 6.1 API集成测试

```typescript
import request from 'supertest';
import { Test } from '@nestjs/testing';
import { AppModule } from '../app.module';

describe('ToolsController (e2e)', () => {
  let app: INestApplication;

  beforeAll(async () => {
    const moduleFixture = await Test.createTestingModule({
      imports: [AppModule],
    }).compile();

    app = moduleFixture.createNestApplication();
    await app.init();
  });

  afterAll(async () => {
    await app.close();
  });

  it('/tools (GET)', () => {
    return request(app.getHttpServer())
      .get('/tools')
      .expect(200)
      .expect((res) => {
        expect(Array.isArray(res.body.data.items)).toBe(true);
      });
  });

  it('/tools (POST)', () => {
    return request(app.getHttpServer())
      .post('/tools')
      .send({
        name: 'Test Tool',
        description: 'Test Description',
      })
      .expect(201);
  });
});
```

## 7. E2E测试规范

### 7.1 Playwright示例

```typescript
import { test, expect } from '@playwright/test';

test.describe('Tool Marketplace', () => {
  test('should display tool list', async ({ page }) => {
    await page.goto('/tools');
    
    await expect(page.locator('h1')).toContainText('工具广场');
    await expect(page.locator('.tool-card')).toHaveCount(6);
  });

  test('should filter tools by category', async ({ page }) => {
    await page.goto('/tools');
    
    await page.click('text=创作');
    
    const tools = page.locator('.tool-card');
    await expect(tools).toHaveCount(2);
  });
});
```

## 8. Mock数据规范

### 8.1 前端Mock（MSW）

```typescript
import { rest } from 'msw';
import { setupServer } from 'msw/node';

export const server = setupServer(
  rest.get('/api/v1/tools', (req, res, ctx) => {
    return res(
      ctx.json({
        code: 200,
        data: {
          items: [
            { id: 1, name: 'Test Tool' },
          ],
        },
      })
    );
  })
);
```

### 8.2 后端Mock（Jest）

```typescript
jest.mock('../prisma/prisma.service', () => ({
  PrismaService: {
    tool: {
      findMany: jest.fn(),
      create: jest.fn(),
    },
  },
}));
```

## 9. 测试数据管理

### 9.1 测试数据准备

```typescript
// fixtures/tools.fixture.ts
export const mockTools = [
  {
    id: 1,
    name: 'AI文案生成器',
    category: 'create',
    type: 'agent',
  },
  {
    id: 2,
    name: '数据分析助手',
    category: 'data',
    type: 'api',
  },
];
```

### 9.2 测试数据库

- 使用独立的测试数据库
- 每个测试前清理数据
- 使用事务回滚（如可能）

## 10. 测试覆盖率

### 10.1 覆盖率要求

- **单元测试**: ≥80%
- **集成测试**: ≥60%
- **E2E测试**: 核心流程100%

### 10.2 覆盖率报告

```bash
# 生成覆盖率报告
npm run test:coverage

# 查看报告
open coverage/index.html
```

## 11. 测试最佳实践

### 11.1 测试原则

- **独立性**: 测试之间不相互依赖
- **可重复**: 每次运行结果一致
- **快速**: 单元测试应该快速执行
- **清晰**: 测试代码易于理解

### 11.2 测试编写

- 一个测试一个断言（理想情况）
- 使用描述性的测试名称
- 避免测试实现细节
- 测试边界情况

### 11.3 测试维护

- 及时更新测试
- 删除过时的测试
- 重构测试代码
- 保持测试简洁

## 12. CI/CD集成

### 12.1 测试执行

```yaml
# .github/workflows/test.yml
name: Test

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
      - run: npm ci
      - run: npm run test
      - run: npm run test:coverage
```

## 13. 检查清单

- [ ] 测试工具配置
- [ ] 测试文件组织规范
- [ ] 单元测试编写规范
- [ ] 集成测试编写规范
- [ ] E2E测试编写规范
- [ ] Mock数据管理
- [ ] 测试覆盖率达标
- [ ] CI/CD集成测试

---

**相关文档**:
- [后端代码规范](./03-后端代码规范.md)
- [部署与CI-CD规范](./11-部署与CI-CD规范.md)

