# 后端代码规范文档

> **版本**: v1.0.0  
> **最后更新**: 2024-11-18

## 1. 概述

本文档定义了AI能力交易平台后端（NestJS）的代码规范，包括项目结构、代码风格、模块化设计、错误处理等。

## 2. 技术栈

- **框架**: NestJS 10.x
- **语言**: TypeScript 5.x
- **ORM**: Prisma 5.x
- **数据库**: PostgreSQL 15+
- **缓存**: Redis 7+
- **认证**: JWT + Passport.js
- **验证**: class-validator + class-transformer
- **文档**: Swagger/OpenAPI

## 3. 项目结构

### 3.1 目录结构

```
backend/
├── src/
│   ├── main.ts                 # 应用入口
│   ├── app.module.ts           # 根模块
│   ├── common/                 # 公共模块
│   │   ├── decorators/         # 自定义装饰器
│   │   ├── filters/            # 异常过滤器
│   │   ├── guards/             # 守卫
│   │   ├── interceptors/       # 拦截器
│   │   ├── pipes/              # 管道
│   │   └── utils/              # 工具函数
│   ├── config/                 # 配置文件
│   │   ├── database.config.ts
│   │   ├── redis.config.ts
│   │   └── app.config.ts
│   ├── modules/                # 业务模块
│   │   ├── auth/               # 认证模块
│   │   ├── users/              # 用户模块
│   │   ├── tools/              # 工具模块
│   │   ├── demands/            # 需求模块
│   │   ├── projects/           # 项目模块
│   │   ├── comments/           # 评论模块
│   │   └── notifications/      # 通知模块
│   └── shared/                 # 共享模块
│       ├── dto/                # 数据传输对象
│       ├── entities/           # 实体类型
│       └── interfaces/         # 接口定义
├── prisma/
│   ├── schema.prisma           # Prisma Schema
│   └── migrations/             # 数据库迁移
├── test/                       # 测试文件
├── .env.example                # 环境变量示例
├── nest-cli.json               # NestJS配置
├── tsconfig.json               # TypeScript配置
└── package.json
```

### 3.2 模块结构

每个业务模块应包含：

```
modules/tools/
├── tools.module.ts             # 模块定义
├── tools.controller.ts         # 控制器
├── tools.service.ts            # 服务层
├── tools.repository.ts         # 数据访问层（可选）
├── dto/
│   ├── create-tool.dto.ts
│   ├── update-tool.dto.ts
│   └── query-tool.dto.ts
├── entities/
│   └── tool.entity.ts
└── tools.controller.spec.ts    # 测试文件
```

## 4. 代码风格

### 4.1 命名规范

#### 文件命名

- 使用 kebab-case: `user-profile.service.ts`
- 测试文件: `user-profile.service.spec.ts`

#### 类命名

- 使用 PascalCase: `UserProfileService`
- 控制器: `UsersController`
- 服务: `UsersService`
- DTO: `CreateUserDto`
- 实体: `User`

#### 变量和函数命名

- 使用 camelCase: `getUserById`
- 常量: `UPPER_SNAKE_CASE`: `MAX_RETRY_COUNT`

### 4.2 代码格式

#### 导入顺序

```typescript
// 1. 外部库
import { Injectable } from '@nestjs/common';
import { PrismaService } from 'nestjs-prisma';

// 2. 内部模块
import { UsersService } from '../users/users.service';

// 3. 类型导入
import type { CreateUserDto } from './dto/create-user.dto';
```

#### 类结构顺序

```typescript
export class UsersService {
  // 1. 属性
  private readonly logger = new Logger(UsersService.name);

  // 2. 构造函数
  constructor(
    private readonly prisma: PrismaService,
  ) {}

  // 3. 公共方法
  async findAll(): Promise<User[]> {
    // ...
  }

  // 4. 私有方法
  private validateUser(user: User): boolean {
    // ...
  }
}
```

## 5. 模块设计

### 5.1 模块职责

#### Controller（控制器）

- 处理HTTP请求
- 参数验证
- 调用Service
- 返回响应

```typescript
@Controller('tools')
export class ToolsController {
  constructor(private readonly toolsService: ToolsService) {}

  @Get()
  async findAll(@Query() query: QueryToolDto) {
    return this.toolsService.findAll(query);
  }

  @Post()
  @UseGuards(JwtAuthGuard)
  async create(@Body() createToolDto: CreateToolDto) {
    return this.toolsService.create(createToolDto);
  }
}
```

#### Service（服务层）

- 业务逻辑处理
- 数据验证
- 调用Repository
- 事务管理

```typescript
@Injectable()
export class ToolsService {
  constructor(
    private readonly prisma: PrismaService,
    private readonly logger: new Logger(ToolsService.name),
  ) {}

  async findAll(query: QueryToolDto): Promise<PaginatedResult<Tool>> {
    // 业务逻辑
  }

  async create(createToolDto: CreateToolDto): Promise<Tool> {
    // 业务逻辑
  }
}
```

#### Repository（数据访问层，可选）

- 数据库操作封装
- 查询构建
- 数据转换

```typescript
@Injectable()
export class ToolsRepository {
  constructor(private readonly prisma: PrismaService) {}

  async findMany(options: FindManyOptions): Promise<Tool[]> {
    return this.prisma.tool.findMany(options);
  }
}
```

### 5.2 依赖注入

使用构造函数注入：

```typescript
@Injectable()
export class ToolsService {
  constructor(
    private readonly prisma: PrismaService,
    private readonly usersService: UsersService,
  ) {}
}
```

## 6. DTO（数据传输对象）

### 6.1 DTO定义

```typescript
import { IsString, IsOptional, IsNumber, Min, Max } from 'class-validator';
import { ApiProperty, ApiPropertyOptional } from '@nestjs/swagger';

export class CreateToolDto {
  @ApiProperty({ description: '工具名称' })
  @IsString()
  @MinLength(2)
  @MaxLength(100)
  name: string;

  @ApiPropertyOptional({ description: '工具描述' })
  @IsOptional()
  @IsString()
  @MaxLength(500)
  description?: string;

  @ApiProperty({ description: '分类' })
  @IsString()
  category: string;

  @ApiProperty({ description: '价格' })
  @IsNumber()
  @Min(0)
  price: number;
}
```

### 6.2 验证规则

使用 class-validator 装饰器：

```typescript
@IsString()           // 字符串
@IsNumber()           // 数字
@IsEmail()            // 邮箱
@IsOptional()         // 可选
@Min(0)               // 最小值
@Max(100)             // 最大值
@MinLength(2)         // 最小长度
@MaxLength(100)       // 最大长度
@IsEnum()             // 枚举
@IsArray()            // 数组
```

## 7. 异常处理

### 7.1 自定义异常

```typescript
export class ToolNotFoundException extends NotFoundException {
  constructor(id: number) {
    super(`Tool with ID ${id} not found`);
  }
}
```

### 7.2 全局异常过滤器

```typescript
@Catch()
export class AllExceptionsFilter implements ExceptionFilter {
  catch(exception: unknown, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const response = ctx.getResponse();
    const request = ctx.getRequest();

    const status = exception instanceof HttpException
      ? exception.getStatus()
      : 500;

    response.status(status).json({
      code: status,
      message: exception.message || 'Internal server error',
      timestamp: new Date().toISOString(),
      path: request.url,
    });
  }
}
```

### 7.3 使用示例

```typescript
async findOne(id: number): Promise<Tool> {
  const tool = await this.prisma.tool.findUnique({ where: { id } });
  
  if (!tool) {
    throw new ToolNotFoundException(id);
  }
  
  return tool;
}
```

## 8. 认证授权

### 8.1 JWT认证

```typescript
@UseGuards(JwtAuthGuard)
@Get('profile')
async getProfile(@CurrentUser() user: User) {
  return user;
}
```

### 8.2 角色守卫

```typescript
@Roles('admin')
@UseGuards(JwtAuthGuard, RolesGuard)
@Delete(':id')
async remove(@Param('id') id: number) {
  return this.toolsService.remove(id);
}
```

### 8.3 自定义装饰器

```typescript
export const CurrentUser = createParamDecorator(
  (data: unknown, ctx: ExecutionContext): User => {
    const request = ctx.switchToHttp().getRequest();
    return request.user;
  },
);
```

## 9. 数据库操作

### 9.1 Prisma使用

```typescript
// 查询
const tools = await this.prisma.tool.findMany({
  where: { category: 'create' },
  include: { author: true },
  orderBy: { createdAt: 'desc' },
  take: 20,
  skip: 0,
});

// 创建
const tool = await this.prisma.tool.create({
  data: {
    name: 'AI工具',
    description: '描述',
    authorId: userId,
  },
});

// 更新
const updated = await this.prisma.tool.update({
  where: { id },
  data: { name: '新名称' },
});

// 删除
await this.prisma.tool.delete({
  where: { id },
});
```

### 9.2 事务处理

```typescript
await this.prisma.$transaction(async (tx) => {
  const tool = await tx.tool.create({ data: toolData });
  await tx.toolTag.createMany({
    data: tags.map(tag => ({ toolId: tool.id, tagId: tag.id })),
  });
  return tool;
});
```

## 10. 日志记录

### 10.1 Logger使用

```typescript
import { Logger } from '@nestjs/common';

export class ToolsService {
  private readonly logger = new Logger(ToolsService.name);

  async create(dto: CreateToolDto) {
    this.logger.log(`Creating tool: ${dto.name}`);
    
    try {
      const tool = await this.prisma.tool.create({ data: dto });
      this.logger.log(`Tool created: ${tool.id}`);
      return tool;
    } catch (error) {
      this.logger.error(`Failed to create tool: ${error.message}`, error.stack);
      throw error;
    }
  }
}
```

### 10.2 日志级别

- `log`: 一般信息
- `warn`: 警告信息
- `error`: 错误信息
- `debug`: 调试信息
- `verbose`: 详细信息

## 11. 配置管理

### 11.1 环境变量

使用 `@nestjs/config`:

```typescript
// config/app.config.ts
export default () => ({
  port: parseInt(process.env.PORT, 10) || 3000,
  database: {
    url: process.env.DATABASE_URL,
  },
  jwt: {
    secret: process.env.JWT_SECRET,
    expiresIn: process.env.JWT_EXPIRES_IN || '1h',
  },
});
```

### 11.2 配置使用

```typescript
@Module({
  imports: [
    ConfigModule.forRoot({
      isGlobal: true,
      load: [appConfig],
    }),
  ],
})
export class AppModule {}

// 使用
constructor(
  @Inject(appConfig.KEY) private config: ConfigType<typeof appConfig>,
) {}
```

## 12. API文档

### 12.1 Swagger集成

```typescript
// main.ts
const config = new DocumentBuilder()
  .setTitle('AI能力交易平台 API')
  .setDescription('API文档')
  .setVersion('1.0')
  .addBearerAuth()
  .build();

const document = SwaggerModule.createDocument(app, config);
SwaggerModule.setup('api-docs', app, document);
```

### 12.2 API装饰器

```typescript
@ApiTags('tools')
@Controller('tools')
export class ToolsController {
  @ApiOperation({ summary: '获取工具列表' })
  @ApiResponse({ status: 200, description: '成功' })
  @Get()
  async findAll() {
    // ...
  }
}
```

## 13. 测试规范

### 13.1 单元测试

```typescript
describe('ToolsService', () => {
  let service: ToolsService;
  let prisma: PrismaService;

  beforeEach(async () => {
    const module = await Test.createTestingModule({
      providers: [
        ToolsService,
        {
          provide: PrismaService,
          useValue: mockPrismaService,
        },
      ],
    }).compile();

    service = module.get<ToolsService>(ToolsService);
    prisma = module.get<PrismaService>(PrismaService);
  });

  it('should be defined', () => {
    expect(service).toBeDefined();
  });

  describe('findAll', () => {
    it('should return an array of tools', async () => {
      const result = await service.findAll({});
      expect(result).toBeInstanceOf(Array);
    });
  });
});
```

### 13.2 E2E测试

```typescript
describe('ToolsController (e2e)', () => {
  let app: INestApplication;

  beforeAll(async () => {
    const moduleFixture = await Test.createTestingModule({
      imports: [AppModule],
    }).compile();

    app = moduleFixture.createNestApplication();
    await app.init();
  });

  it('/tools (GET)', () => {
    return request(app.getHttpServer())
      .get('/tools')
      .expect(200);
  });
});
```

## 14. 性能优化

### 14.1 查询优化

- 使用 `select` 只查询需要的字段
- 使用 `include` 预加载关联数据
- 使用索引优化查询

### 14.2 缓存策略

```typescript
@Injectable()
export class ToolsService {
  constructor(
    private readonly prisma: PrismaService,
    @Inject(CACHE_MANAGER) private cacheManager: Cache,
  ) {}

  async findOne(id: number): Promise<Tool> {
    const cacheKey = `tool:${id}`;
    const cached = await this.cacheManager.get<Tool>(cacheKey);
    
    if (cached) {
      return cached;
    }

    const tool = await this.prisma.tool.findUnique({ where: { id } });
    await this.cacheManager.set(cacheKey, tool, 3600);
    
    return tool;
  }
}
```

## 15. 安全检查清单

- [ ] 输入验证（DTO验证）
- [ ] SQL注入防护（使用Prisma参数化查询）
- [ ] XSS防护（输出转义）
- [ ] CSRF防护（使用CSRF Token）
- [ ] 速率限制（Throttler）
- [ ] 敏感信息加密（密码哈希）
- [ ] 权限验证（Guards）
- [ ] 日志记录（不记录敏感信息）

## 16. 最佳实践

1. **单一职责**: 每个类只做一件事
2. **依赖注入**: 使用DI而不是直接实例化
3. **错误处理**: 使用异常而不是返回错误码
4. **类型安全**: 充分利用TypeScript类型系统
5. **文档完善**: 所有公共API都要有文档
6. **测试覆盖**: 关键业务逻辑要有测试

## 17. 检查清单

- [ ] 项目结构规范
- [ ] 命名规范统一
- [ ] 模块职责清晰
- [ ] DTO验证完善
- [ ] 异常处理统一
- [ ] 认证授权实现
- [ ] 日志记录完善
- [ ] 配置管理规范
- [ ] API文档完整
- [ ] 测试覆盖充分
- [ ] 性能优化到位
- [ ] 安全检查通过

---

**相关文档**:
- [API规范](./01-API规范.md)
- [错误处理规范](./20-错误处理规范.md)
- [安全开发规范](./14-安全开发规范.md)
- [测试规范](./10-测试规范.md)

