# 数据库操作规范文档

> **版本**: v1.0.0  
> **最后更新**: 2024-11-18

## 1. 概述

本文档定义了AI能力交易平台的数据库操作规范，包括Migration、索引、查询优化、连接池等。

## 2. Prisma Migration规范

### 2.1 Migration创建

```bash
# 开发环境：创建并应用迁移
npx prisma migrate dev --name add_user_level

# 生产环境：只应用迁移
npx prisma migrate deploy
```

### 2.2 Migration文件规范

#### 文件命名

```
migrations/
├── 20241118000000_add_user_level/
│   └── migration.sql
├── 20241119000000_add_tool_tags/
│   └── migration.sql
```

#### Migration内容

```sql
-- CreateTable
CREATE TABLE "users" (
    "id" SERIAL NOT NULL,
    "email" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "created_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "users_pkey" PRIMARY KEY ("id")
);

-- CreateIndex
CREATE INDEX "users_email_idx" ON "users"("email");
```

### 2.3 Migration最佳实践

- **小步迁移**: 每次迁移只做一件事
- **可回滚**: 考虑回滚方案
- **数据迁移**: 大表迁移分批次
- **测试验证**: 迁移前充分测试

## 3. 索引优化

### 3.1 索引创建原则

#### 何时创建索引

- 频繁查询的字段
- 外键字段
- 排序字段
- 分组字段
- 唯一约束字段

#### 何时不创建索引

- 很少查询的字段
- 频繁更新的字段（需权衡）
- 数据量很小的表

### 3.2 索引类型

#### 单列索引

```prisma
model Tool {
  // ...
  
  @@index([category])
  @@index([authorId])
}
```

#### 复合索引

```prisma
model Tool {
  // ...
  
  @@index([category, status, isFeatured])
}
```

#### 唯一索引

```prisma
model User {
  email String @unique
  
  @@index([email])
}
```

### 3.3 索引优化建议

- **覆盖索引**: 包含查询所需的所有字段
- **索引顺序**: 高选择性字段在前
- **避免过多索引**: 影响写入性能

## 4. 查询优化

### 4.1 查询原则

#### 只查询需要的字段

```typescript
// ✅ 推荐：只查询需要的字段
const tools = await prisma.tool.findMany({
  select: {
    id: true,
    name: true,
    description: true,
  },
});

// ❌ 不推荐：查询所有字段
const tools = await prisma.tool.findMany();
```

#### 使用include预加载

```typescript
// ✅ 推荐：预加载关联数据
const tool = await prisma.tool.findUnique({
  where: { id },
  include: {
    author: {
      select: { id: true, name: true },
    },
    tags: true,
  },
});

// ❌ 不推荐：N+1查询
const tool = await prisma.tool.findUnique({ where: { id } });
const author = await prisma.user.findUnique({ where: { id: tool.authorId } });
```

### 4.2 避免N+1查询

```typescript
// ❌ N+1查询
const tools = await prisma.tool.findMany();
for (const tool of tools) {
  const author = await prisma.user.findUnique({ where: { id: tool.authorId } });
}

// ✅ 使用include
const tools = await prisma.tool.findMany({
  include: { author: true },
});
```

### 4.3 分页优化

#### 游标分页（推荐）

```typescript
const tools = await prisma.tool.findMany({
  take: 20,
  cursor: { id: lastId },
  orderBy: { id: 'asc' },
});
```

#### 偏移分页（小数据量）

```typescript
const tools = await prisma.tool.findMany({
  skip: (page - 1) * limit,
  take: limit,
});
```

## 5. 连接池配置

### 5.1 Prisma连接池

```prisma
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // 连接池配置在URL中
  // ?connection_limit=10&pool_timeout=20
}
```

### 5.2 连接池参数

- **connection_limit**: 最大连接数（默认10）
- **pool_timeout**: 连接超时（秒）
- **connect_timeout**: 连接建立超时（秒）

### 5.3 连接池优化

- 根据服务器配置调整
- 监控连接池使用情况
- 避免连接泄漏

## 6. 事务处理

### 6.1 事务使用场景

- 多表操作需要一致性
- 批量操作
- 数据迁移

### 6.2 事务示例

```typescript
await prisma.$transaction(async (tx) => {
  // 1. 创建工具
  const tool = await tx.tool.create({ data: toolData });
  
  // 2. 创建标签关联
  await tx.toolTag.createMany({
    data: tags.map(tagId => ({ toolId: tool.id, tagId })),
  });
  
  // 3. 更新统计
  await tx.user.update({
    where: { id: userId },
    data: { toolsCount: { increment: 1 } },
  });
  
  return tool;
});
```

### 6.3 事务最佳实践

- 保持事务简短
- 避免长时间锁定
- 处理事务失败
- 记录事务日志

## 7. 批量操作

### 7.1 批量插入

```typescript
// ✅ 推荐：批量插入
await prisma.toolTag.createMany({
  data: tags.map(tagId => ({ toolId, tagId })),
  skipDuplicates: true,
});

// ❌ 不推荐：循环插入
for (const tagId of tags) {
  await prisma.toolTag.create({ data: { toolId, tagId } });
}
```

### 7.2 批量更新

```typescript
// 使用事务批量更新
await prisma.$transaction(
  items.map(item =>
    prisma.tool.update({
      where: { id: item.id },
      data: item,
    })
  )
);
```

## 8. 查询性能监控

### 8.1 慢查询监控

```typescript
const prisma = new PrismaClient({
  log: [
    { emit: 'event', level: 'query' },
  ],
});

prisma.$on('query', (e) => {
  if (e.duration > 100) {
    logger.warn(`Slow query: ${e.query} took ${e.duration}ms`);
  }
});
```

### 8.2 查询分析

- 使用 `EXPLAIN ANALYZE` 分析查询计划
- 检查索引使用情况
- 优化慢查询

## 9. 数据一致性

### 9.1 外键约束

```prisma
model Tool {
  authorId Int
  author   User @relation(fields: [authorId], references: [id], onDelete: Cascade)
}
```

### 9.2 唯一约束

```prisma
model User {
  email String @unique
}
```

### 9.3 检查约束

```sql
ALTER TABLE tools 
ADD CONSTRAINT chk_price_non_negative 
CHECK (price >= 0);
```

## 10. 数据库维护

### 10.1 定期维护

- **VACUUM**: 清理死元组
- **ANALYZE**: 更新统计信息
- **REINDEX**: 重建索引

### 10.2 维护脚本

```sql
-- 清理和分析
VACUUM ANALYZE tools;

-- 重建索引
REINDEX TABLE tools;
```

## 11. 检查清单

- [ ] Migration规范遵循
- [ ] 索引优化到位
- [ ] 查询优化完成
- [ ] 连接池配置合理
- [ ] 事务使用正确
- [ ] 批量操作优化
- [ ] 性能监控配置
- [ ] 数据一致性保证
- [ ] 维护计划制定

---

**相关文档**:
- [数据库规范](./06-数据库规范.md)
- [后端代码规范](./03-后端代码规范.md)
- [性能优化规范](./13-性能优化规范.md)

