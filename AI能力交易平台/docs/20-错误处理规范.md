# 错误处理规范文档

> **版本**: v1.0.0  
> **最后更新**: 2024-11-18

## 1. 概述

本文档定义了AI能力交易平台的错误处理规范，包括统一错误码、错误信息格式、错误日志记录等。

## 2. 错误码体系

### 2.1 错误码结构

```
XXYYZZ
││││││
││││└─ 具体错误编号（00-99）
││└─── 模块编号（00-99）
└───── 错误类型（10-99）
```

### 2.2 错误类型

| 类型 | 范围 | 说明 |
|------|------|------|
| 10-19 | 系统错误 | 服务器内部错误 |
| 20-29 | 认证错误 | 认证授权相关 |
| 30-39 | 参数错误 | 请求参数错误 |
| 40-49 | 业务错误 | 业务逻辑错误 |
| 50-59 | 资源错误 | 资源不存在或冲突 |
| 60-69 | 权限错误 | 权限不足 |
| 70-79 | 限流错误 | 请求频率限制 |
| 80-89 | 外部服务错误 | 第三方服务错误 |
| 90-99 | 数据错误 | 数据验证或处理错误 |

### 2.3 错误码定义

#### 系统错误（10xx）

```typescript
export enum SystemErrorCode {
  INTERNAL_ERROR = 100001,      // 服务器内部错误
  SERVICE_UNAVAILABLE = 100002, // 服务不可用
  DATABASE_ERROR = 100003,      // 数据库错误
  CACHE_ERROR = 100004,         // 缓存错误
}
```

#### 认证错误（20xx）

```typescript
export enum AuthErrorCode {
  UNAUTHORIZED = 200001,        // 未认证
  TOKEN_EXPIRED = 200002,       // Token过期
  TOKEN_INVALID = 200003,       // Token无效
  TOKEN_MISSING = 200004,       // Token缺失
  PASSWORD_INCORRECT = 200005,  // 密码错误
}
```

#### 参数错误（30xx）

```typescript
export enum ValidationErrorCode {
  INVALID_INPUT = 300001,       // 输入无效
  MISSING_REQUIRED = 300002,    // 缺少必需参数
  INVALID_FORMAT = 300003,      // 格式错误
  OUT_OF_RANGE = 300004,        // 超出范围
}
```

#### 业务错误（40xx）

```typescript
export enum BusinessErrorCode {
  OPERATION_FAILED = 400001,    // 操作失败
  INVALID_STATE = 400002,       // 状态无效
  DUPLICATE_ENTRY = 400003,     // 重复条目
}
```

#### 资源错误（50xx）

```typescript
export enum ResourceErrorCode {
  NOT_FOUND = 500001,           // 资源不存在
  ALREADY_EXISTS = 500002,      // 资源已存在
  CONFLICT = 500003,            // 资源冲突
}
```

#### 权限错误（60xx）

```typescript
export enum PermissionErrorCode {
  FORBIDDEN = 600001,           // 无权限
  INSUFFICIENT_PERMISSION = 600002, // 权限不足
}
```

## 3. 错误响应格式

### 3.1 标准错误响应

```json
{
  "code": 500001,
  "message": "Tool not found",
  "errors": [
    {
      "field": "id",
      "message": "Tool with ID 123 does not exist"
    }
  ],
  "timestamp": "2024-11-18T10:00:00Z",
  "requestId": "550e8400-e29b-41d4-a716-446655440000",
  "path": "/api/v1/tools/123"
}
```

### 3.2 错误响应类

```typescript
export class AppException extends HttpException {
  constructor(
    public readonly errorCode: number,
    message: string,
    statusCode: number = 400,
    public readonly errors?: FieldError[],
  ) {
    super(
      {
        code: errorCode,
        message,
        errors,
        timestamp: new Date().toISOString(),
      },
      statusCode,
    );
  }
}

export class ToolNotFoundException extends AppException {
  constructor(id: number) {
    super(
      ResourceErrorCode.NOT_FOUND,
      `Tool with ID ${id} not found`,
      404,
      [{ field: 'id', message: `Tool with ID ${id} does not exist` }],
    );
  }
}
```

## 4. 错误处理实现

### 4.1 全局异常过滤器

```typescript
@Catch()
export class AllExceptionsFilter implements ExceptionFilter {
  catch(exception: unknown, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const response = ctx.getResponse();
    const request = ctx.getRequest();

    let status = 500;
    let errorCode = SystemErrorCode.INTERNAL_ERROR;
    let message = 'Internal server error';
    let errors: FieldError[] = [];

    if (exception instanceof AppException) {
      status = exception.getStatus();
      errorCode = exception.errorCode;
      message = exception.message;
      errors = exception.errors || [];
    } else if (exception instanceof HttpException) {
      status = exception.getStatus();
      message = exception.message;
    }

    const errorResponse = {
      code: errorCode,
      message,
      errors,
      timestamp: new Date().toISOString(),
      requestId: request.id,
      path: request.url,
    };

    // 记录错误日志
    this.logger.error(exception, JSON.stringify(errorResponse));

    response.status(status).json(errorResponse);
  }
}
```

### 4.2 业务错误处理

```typescript
@Injectable()
export class ToolsService {
  async findOne(id: number): Promise<Tool> {
    const tool = await this.prisma.tool.findUnique({ where: { id } });
    
    if (!tool) {
      throw new ToolNotFoundException(id);
    }
    
    return tool;
  }

  async create(dto: CreateToolDto, userId: number): Promise<Tool> {
    // 检查重复
    const existing = await this.prisma.tool.findFirst({
      where: {
        name: dto.name,
        authorId: userId,
      },
    });

    if (existing) {
      throw new AppException(
        BusinessErrorCode.DUPLICATE_ENTRY,
        'Tool with this name already exists',
        409,
      );
    }

    return this.prisma.tool.create({
      data: { ...dto, authorId: userId },
    });
  }
}
```

## 5. 前端错误处理

### 5.1 错误拦截器

```typescript
// lib/api/client.ts
apiClient.interceptors.response.use(
  (response) => response.data,
  (error) => {
    if (error.response) {
      const { code, message, errors } = error.response.data;
      
      // 根据错误码处理
      switch (code) {
        case 200002: // Token过期
          // 刷新Token或跳转登录
          break;
        case 500001: // 资源不存在
          // 显示404页面
          break;
        default:
          // 显示错误提示
          toast.error(message);
      }
    }
    
    return Promise.reject(error);
  }
);
```

### 5.2 错误边界

```typescript
class ErrorBoundary extends React.Component {
  state = { hasError: false, error: null };

  static getDerivedStateFromError(error: Error) {
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
    // 发送错误到监控服务
    console.error('Error caught:', error, errorInfo);
  }

  render() {
    if (this.state.hasError) {
      return <ErrorFallback error={this.state.error} />;
    }
    return this.props.children;
  }
}
```

## 6. 错误信息国际化

### 6.1 错误信息映射

```typescript
const errorMessages = {
  'zh-CN': {
    [ResourceErrorCode.NOT_FOUND]: '资源不存在',
    [AuthErrorCode.UNAUTHORIZED]: '未授权，请先登录',
    [ValidationErrorCode.INVALID_INPUT]: '输入无效',
  },
  'en-US': {
    [ResourceErrorCode.NOT_FOUND]: 'Resource not found',
    [AuthErrorCode.UNAUTHORIZED]: 'Unauthorized, please login',
    [ValidationErrorCode.INVALID_INPUT]: 'Invalid input',
  },
};
```

### 6.2 使用示例

```typescript
const message = errorMessages[locale][errorCode] || 'Unknown error';
```

## 7. 错误日志记录

### 7.1 日志内容

```typescript
this.logger.error({
  code: errorCode,
  message: error.message,
  stack: error.stack,
  userId: currentUser?.id,
  requestId: request.id,
  path: request.url,
  method: request.method,
  body: request.body,
});
```

### 7.2 敏感信息过滤

```typescript
// 不记录敏感信息
const sanitizedBody = { ...body };
delete sanitizedBody.password;
delete sanitizedBody.token;

this.logger.error({
  body: sanitizedBody,
});
```

## 8. 用户友好错误提示

### 8.1 错误提示原则

- **清晰**: 错误信息清晰易懂
- **可操作**: 提供解决建议
- **友好**: 使用友好的语言
- **具体**: 指出具体问题

### 8.2 错误提示示例

```typescript
// ❌ 不友好
"Error"

// ✅ 友好
"工具不存在，请检查工具ID是否正确"

// ✅ 更友好（带建议）
"工具不存在，请检查工具ID是否正确。您可以返回工具列表重新选择。"
```

## 9. 错误恢复策略

### 9.1 自动重试

```typescript
async function retryOperation<T>(
  operation: () => Promise<T>,
  maxRetries: number = 3,
): Promise<T> {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await operation();
    } catch (error) {
      if (i === maxRetries - 1) throw error;
      await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
    }
  }
}
```

### 9.2 降级策略

```typescript
// 缓存降级
async function getToolsWithFallback() {
  try {
    return await api.getTools();
  } catch (error) {
    // 从缓存获取
    return getCachedTools();
  }
}
```

## 10. 检查清单

- [ ] 错误码体系定义
- [ ] 错误响应格式统一
- [ ] 全局异常过滤器
- [ ] 业务错误处理
- [ ] 前端错误处理
- [ ] 错误边界实现
- [ ] 错误信息国际化
- [ ] 错误日志记录
- [ ] 用户友好提示
- [ ] 错误恢复策略

---

**相关文档**:
- [API规范](./01-API规范.md)
- [后端代码规范](./03-后端代码规范.md)
- [日志与监控规范](./15-日志与监控规范.md)

