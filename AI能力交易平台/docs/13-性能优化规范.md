# 性能优化规范文档

> **版本**: v1.0.0  
> **最后更新**: 2024-11-18

## 1. 概述

本文档定义了AI能力交易平台的性能优化规范，包括前后端性能指标、缓存策略、优化方法等。

## 2. 性能指标

### 2.1 前端性能指标

#### Core Web Vitals

- **LCP (Largest Contentful Paint)**: < 2.5s
- **FID (First Input Delay)**: < 100ms
- **CLS (Cumulative Layout Shift)**: < 0.1

#### 其他指标

- **FCP (First Contentful Paint)**: < 1.8s
- **TTI (Time to Interactive)**: < 3.8s
- **TBT (Total Blocking Time)**: < 200ms

### 2.2 后端性能指标

- **API响应时间**: P95 < 200ms, P99 < 500ms
- **数据库查询**: < 100ms
- **并发处理**: 支持1000+ QPS
- **错误率**: < 0.1%

## 3. 前端性能优化

### 3.1 代码分割

```typescript
// 路由懒加载
const ToolMarketplace = lazy(() => import('./components/ToolMarketplace'));
const DemandMarketplace = lazy(() => import('./components/DemandMarketplace'));

// 组件懒加载
const HeavyComponent = lazy(() => import('./HeavyComponent'));
```

### 3.2 资源优化

#### 图片优化

```typescript
// 使用WebP格式
<img src="image.webp" alt="..." />

// 懒加载
<img src="image.jpg" loading="lazy" alt="..." />

// 响应式图片
<img 
  srcSet="image-small.jpg 400w, image-large.jpg 800w"
  sizes="(max-width: 600px) 400px, 800px"
  src="image.jpg"
/>
```

#### 字体优化

```css
/* 字体预加载 */
@font-face {
  font-family: 'Poppins';
  src: url('poppins.woff2') format('woff2');
  font-display: swap; /* 避免FOIT */
}
```

### 3.3 打包优化

```typescript
// vite.config.ts
export default defineConfig({
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          'react-vendor': ['react', 'react-dom'],
          'ui-vendor': ['@radix-ui/react-dialog', '@radix-ui/react-popover'],
        },
      },
    },
    chunkSizeWarningLimit: 1000,
  },
});
```

### 3.4 缓存策略

```typescript
// API响应缓存
const cache = new Map();

async function fetchTools() {
  const cacheKey = 'tools';
  if (cache.has(cacheKey)) {
    return cache.get(cacheKey);
  }
  
  const data = await api.get('/tools');
  cache.set(cacheKey, data);
  setTimeout(() => cache.delete(cacheKey), 5 * 60 * 1000); // 5分钟过期
  
  return data;
}
```

## 4. 后端性能优化

### 4.1 数据库优化

#### 索引优化

```prisma
model Tool {
  // ...
  
  @@index([category, status, isFeatured])
  @@index([authorId, createdAt])
}
```

#### 查询优化

```typescript
// 只查询需要的字段
const tools = await prisma.tool.findMany({
  select: {
    id: true,
    name: true,
    description: true,
  },
});

// 使用include预加载
const tool = await prisma.tool.findUnique({
  where: { id },
  include: {
    author: {
      select: { id: true, name: true },
    },
  },
});
```

#### 分页优化

```typescript
// 使用游标分页（推荐）
const tools = await prisma.tool.findMany({
  take: 20,
  cursor: { id: lastId },
  orderBy: { id: 'asc' },
});

// 避免深度分页
// ❌ 不推荐：OFFSET 10000
// ✅ 推荐：使用游标
```

### 4.2 缓存策略

#### Redis缓存

```typescript
@Injectable()
export class ToolsService {
  constructor(
    private readonly prisma: PrismaService,
    @Inject(CACHE_MANAGER) private cacheManager: Cache,
  ) {}

  async findOne(id: number): Promise<Tool> {
    const cacheKey = `tool:${id}`;
    const cached = await this.cacheManager.get<Tool>(cacheKey);
    
    if (cached) {
      return cached;
    }

    const tool = await this.prisma.tool.findUnique({ where: { id } });
    await this.cacheManager.set(cacheKey, tool, 3600); // 1小时
    
    return tool;
  }

  async findHotTools(): Promise<Tool[]> {
    const cacheKey = 'tools:hot';
    const cached = await this.cacheManager.get<Tool[]>(cacheKey);
    
    if (cached) {
      return cached;
    }

    const tools = await this.prisma.tool.findMany({
      where: { isFeatured: true },
      orderBy: { users: 'desc' },
      take: 10,
    });
    
    await this.cacheManager.set(cacheKey, tools, 300); // 5分钟
    
    return tools;
  }
}
```

#### 缓存失效策略

```typescript
// 更新时清除缓存
async update(id: number, data: UpdateToolDto): Promise<Tool> {
  const tool = await this.prisma.tool.update({
    where: { id },
    data,
  });
  
  // 清除相关缓存
  await this.cacheManager.del(`tool:${id}`);
  await this.cacheManager.del('tools:hot');
  await this.cacheManager.del('tools:list');
  
  return tool;
}
```

### 4.3 批量操作优化

```typescript
// ❌ 不推荐：N+1查询
for (const toolId of toolIds) {
  const tool = await prisma.tool.findUnique({ where: { id: toolId } });
}

// ✅ 推荐：批量查询
const tools = await prisma.tool.findMany({
  where: { id: { in: toolIds } },
});
```

## 5. API性能优化

### 5.1 响应压缩

```typescript
// 启用Gzip压缩
import compression from 'compression';

app.use(compression());
```

### 5.2 请求合并

```typescript
// 合并多个请求
// 前端：使用Promise.all
const [tools, demands, projects] = await Promise.all([
  api.get('/tools'),
  api.get('/demands'),
  api.get('/projects'),
]);
```

### 5.3 字段选择

```typescript
// 使用fields参数控制返回字段
GET /api/v1/tools?fields=id,name,description
```

## 6. 图片和资源优化

### 6.1 图片优化

- **格式选择**: WebP > JPEG > PNG
- **尺寸优化**: 响应式图片，按需加载
- **CDN加速**: 使用CDN分发静态资源
- **懒加载**: 非首屏图片懒加载

### 6.2 静态资源

- **压缩**: Gzip/Brotli压缩
- **CDN**: 静态资源使用CDN
- **缓存**: 设置长期缓存（1年）

## 7. 监控和分析

### 7.1 性能监控

```typescript
// 前端性能监控
import { getCLS, getFID, getFCP, getLCP, getTTFB } from 'web-vitals';

function sendToAnalytics(metric) {
  // 发送到监控服务
  console.log(metric);
}

getCLS(sendToAnalytics);
getFID(sendToAnalytics);
getFCP(sendToAnalytics);
getLCP(sendToAnalytics);
getTTFB(sendToAnalytics);
```

### 7.2 后端性能监控

```typescript
// 使用拦截器记录响应时间
@Injectable()
export class LoggingInterceptor implements NestInterceptor {
  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
    const now = Date.now();
    return next.handle().pipe(
      tap(() => {
        const responseTime = Date.now() - now;
        if (responseTime > 200) {
          this.logger.warn(`Slow request: ${responseTime}ms`);
        }
      }),
    );
  }
}
```

## 8. 性能优化检查清单

### 8.1 前端检查

- [ ] 代码分割实现
- [ ] 图片优化完成
- [ ] 字体优化完成
- [ ] 打包优化配置
- [ ] 缓存策略实施
- [ ] 懒加载实现
- [ ] Core Web Vitals达标

### 8.2 后端检查

- [ ] 数据库索引优化
- [ ] 查询优化完成
- [ ] 缓存策略实施
- [ ] 批量操作优化
- [ ] API响应时间达标
- [ ] 并发处理能力
- [ ] 监控告警配置

## 9. 性能优化最佳实践

1. **测量优先**: 先测量，再优化
2. **渐进优化**: 逐步优化，避免过度优化
3. **缓存策略**: 合理使用缓存
4. **监控持续**: 持续监控性能指标
5. **定期审查**: 定期审查性能瓶颈

## 10. 检查清单

- [ ] 性能指标定义
- [ ] 前端优化实施
- [ ] 后端优化实施
- [ ] 缓存策略配置
- [ ] 数据库优化完成
- [ ] API优化完成
- [ ] 资源优化完成
- [ ] 监控配置完成

---

**相关文档**:
- [数据库操作规范](./24-数据库操作规范.md)
- [日志与监控规范](./15-日志与监控规范.md)

