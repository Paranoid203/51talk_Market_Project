# 数据库规范文档

> **版本**: v1.0.0  
> **最后更新**: 2024-11-18

## 1. 概述

本文档基于前端代码分析，定义了AI能力交易平台的数据库设计规范，包括表结构设计、关系映射、索引优化和数据交互链路。

## 2. 数据库选型

- **主数据库**: PostgreSQL 15+
- **缓存数据库**: Redis 7+
- **ORM**: Prisma 5.x

## 3. 数据库设计原则

1. **规范化**: 遵循数据库范式，避免数据冗余
2. **性能优先**: 合理使用索引，优化查询性能
3. **可扩展性**: 设计支持未来扩展
4. **数据完整性**: 使用约束保证数据完整性
5. **安全性**: 敏感数据加密存储

## 4. 核心数据模型

### 4.1 用户相关表

#### users - 用户表

```prisma
model User {
  id            Int       @id @default(autoincrement())
  email         String   @unique @db.VarChar(255)
  password      String   @db.VarChar(255)  // 加密存储
  name          String   @db.VarChar(100)
  avatar        String?  @db.VarChar(500)
  department    String   @db.VarChar(100)
  position      String?  @db.VarChar(100)
  level         Int      @default(1)       // 用户等级
  levelName     String   @default("新手")  // 等级名称
  points        Int      @default(0)       // 积分
  role          Role     @default(USER)    // 角色
  status        UserStatus @default(ACTIVE) // 状态
  lastLoginAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // 关系
  createdTools      Tool[]
  createdDemands    Demand[]
  createdProjects   Project[]
  comments          Comment[]
  likes             Like[]
  follows           Follow[] @relation("Follower")
  followers         Follow[] @relation("Following")
  notifications     Notification[]
  certifications    UserCertification[]

  @@index([email])
  @@index([department])
  @@index([role])
  @@map("users")
}

enum Role {
  USER
  DEPT_ADMIN
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  BANNED
}
```

#### departments - 部门表

```prisma
model Department {
  id          Int      @id @default(autoincrement())
  name        String   @unique @db.VarChar(100)
  description String?  @db.Text
  parentId    Int?     // 上级部门ID
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // 关系
  users    User[]
  tools    Tool[]
  demands  Demand[]
  projects Project[]

  @@map("departments")
}
```

### 4.2 工具相关表

#### tools - 工具表

```prisma
model Tool {
  id          Int      @id @default(autoincrement())
  name        String   @db.VarChar(100)
  description String   @db.Text
  category    String   @db.VarChar(50)  // create, data, chat, image, video, text
  type        ToolType @db.VarChar(20)  // agent, api, external
  authorId    Int
  departmentId Int
  price       Decimal  @default(0) @db.Decimal(10, 2)
  icon        String?  @db.VarChar(500)
  coverImage  String?  @db.VarChar(500)
  url         String?  @db.VarChar(500)  // 外部链接
  apiEndpoint String?  @db.VarChar(500)  // API端点
  config      Json?    // 工具配置（JSON）
  users       Int      @default(0)       // 使用人数
  rating      Decimal  @default(0) @db.Decimal(3, 2) // 评分
  reviews     Int      @default(0)       // 评论数
  isFeatured  Boolean  @default(false)
  status      ToolStatus @default(PENDING) // 审核状态
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // 关系
  author      User     @relation(fields: [authorId], references: [id])
  department  Department @relation(fields: [departmentId], references: [id])
  tags        ToolTag[]
  reviews     ToolReview[]
  usages      ToolUsage[]

  @@index([category])
  @@index([type])
  @@index([authorId])
  @@index([status])
  @@index([isFeatured])
  @@index([rating])
  @@map("tools")
}

enum ToolType {
  AGENT
  API
  EXTERNAL
}

enum ToolStatus {
  PENDING
  APPROVED
  REJECTED
}
```

#### tool_tags - 工具标签表

```prisma
model ToolTag {
  id        Int      @id @default(autoincrement())
  toolId    Int
  tagId     Int
  createdAt DateTime @default(now())

  tool      Tool     @relation(fields: [toolId], references: [id], onDelete: Cascade)
  tag       Tag      @relation(fields: [tagId], references: [id])

  @@unique([toolId, tagId])
  @@index([toolId])
  @@index([tagId])
  @@map("tool_tags")
}
```

#### tags - 标签表

```prisma
model Tag {
  id        Int      @id @default(autoincrement())
  name      String   @unique @db.VarChar(50)
  category  String?  @db.VarChar(50)
  createdAt DateTime @default(now())

  toolTags  ToolTag[]
  projectTags ProjectTag[]

  @@index([name])
  @@map("tags")
}
```

#### tool_reviews - 工具评价表

```prisma
model ToolReview {
  id        Int      @id @default(autoincrement())
  toolId    Int
  userId    Int
  rating    Int      // 1-5星
  comment   String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tool      Tool     @relation(fields: [toolId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@unique([toolId, userId])
  @@index([toolId])
  @@index([userId])
  @@map("tool_reviews")
}
```

#### tool_usages - 工具使用记录表

```prisma
model ToolUsage {
  id        Int      @id @default(autoincrement())
  toolId    Int
  userId    Int
  usedAt    DateTime @default(now())

  tool      Tool     @relation(fields: [toolId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@index([toolId])
  @@index([userId])
  @@index([usedAt])
  @@map("tool_usages")
}
```

### 4.3 需求相关表

#### demands - 需求表

```prisma
model Demand {
  id            Int      @id @default(autoincrement())
  title         String   @db.VarChar(200)
  description   String   @db.Text
  category      String   @db.VarChar(50)
  publisherId   Int
  departmentId  Int
  expectedTime  String?  @db.VarChar(50)  // 期望完成时间
  reward        Decimal  @default(0) @db.Decimal(10, 2) // 悬赏金额
  status        DemandStatus @default(ACTIVE)
  views         Int      @default(0)
  followers     Int      @default(0)
  proposals     Int      @default(0)
  isPaid        Boolean  @default(false)
  isFeatured    Boolean  @default(false)
  publishTime   DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // 关系
  publisher     User     @relation(fields: [publisherId], references: [id])
  department    Department @relation(fields: [departmentId], references: [id])
  discussions   Discussion[]
  proposals     Proposal[]
  groupBuys     GroupBuy[]
  followers_rel DemandFollower[]

  @@index([publisherId])
  @@index([departmentId])
  @@index([status])
  @@index([category])
  @@index([isFeatured])
  @@index([publishTime])
  @@map("demands")
}

enum DemandStatus {
  ACTIVE      // 进行中
  IN_PROGRESS // 进行中（已接受方案）
  COMPLETED   // 已完成
  CANCELLED   // 已取消
}
```

#### discussions - 讨论表

```prisma
model Discussion {
  id        Int      @id @default(autoincrement())
  demandId  Int
  userId    Int
  content   String   @db.Text
  likes     Int      @default(0)
  isAccepted Boolean @default(false) // 是否被采纳
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  demand    Demand   @relation(fields: [demandId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@index([demandId])
  @@index([userId])
  @@index([createdAt])
  @@map("discussions")
}
```

#### proposals - 方案表

```prisma
model Proposal {
  id          Int      @id @default(autoincrement())
  demandId    Int
  proposerId  Int
  title       String   @db.VarChar(200)
  description String   @db.Text
  likes       Int      @default(0)
  isAccepted  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  demand      Demand   @relation(fields: [demandId], references: [id], onDelete: Cascade)
  proposer    User     @relation(fields: [proposerId], references: [id])

  @@index([demandId])
  @@index([proposerId])
  @@index([isAccepted])
  @@map("proposals")
}
```

#### group_buys - 团购表

```prisma
model GroupBuy {
  id          Int      @id @default(autoincrement())
  demandId    Int
  current     Int      @default(1)  // 当前人数
  total       Int                    // 目标人数
  price       Decimal  @db.Decimal(10, 2) // 团购价格
  status      GroupBuyStatus @default(ACTIVE)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  demand      Demand   @relation(fields: [demandId], references: [id], onDelete: Cascade)
  members     GroupBuyMember[]

  @@index([demandId])
  @@index([status])
  @@map("group_buys")
}

enum GroupBuyStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}
```

#### group_buy_members - 团购成员表

```prisma
model GroupBuyMember {
  id        Int      @id @default(autoincrement())
  groupBuyId Int
  userId    Int
  joinedAt  DateTime @default(now())

  groupBuy  GroupBuy @relation(fields: [groupBuyId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@unique([groupBuyId, userId])
  @@index([groupBuyId])
  @@index([userId])
  @@map("group_buy_members")
}
```

#### demand_followers - 需求关注表

```prisma
model DemandFollower {
  id        Int      @id @default(autoincrement())
  demandId  Int
  userId    Int
  createdAt DateTime @default(now())

  demand    Demand   @relation(fields: [demandId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@unique([demandId, userId])
  @@index([demandId])
  @@index([userId])
  @@map("demand_followers")
}
```

### 4.4 项目相关表

#### projects - 项目表

```prisma
model Project {
  id                    Int      @id @default(autoincrement())
  title                 String   @db.VarChar(200)
  summary               String   @db.Text
  departmentId          Int
  requesterId           Int
  requesterDepartmentId Int
  projectLeadId         Int
  projectLeadDepartmentId Int
  category              String   @db.VarChar(50)
  status                ProjectStatus
  image                 String?  @db.VarChar(500)
  backgroundImage       String?  @db.VarChar(500)
  publishTime           DateTime @default(now())
  likes                 Int      @default(0)
  comments              Int      @default(0)
  replications          Int      @default(0)  // 复用次数
  views                 Int      @default(0)
  isFeatured            Boolean  @default(false)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // 关系
  department            Department @relation(fields: [departmentId], references: [id])
  requester             User     @relation("Requester", fields: [requesterId], references: [id])
  projectLead           User     @relation("ProjectLead", fields: [projectLeadId], references: [id])
  developers            ProjectDeveloper[]
  tags                  ProjectTag[]
  impact                ProjectImpact?
  comments_rel          Comment[]
  likes_rel             Like[]
  replications_rel      ProjectReplication[]

  @@index([departmentId])
  @@index([category])
  @@index([status])
  @@index([isFeatured])
  @@index([publishTime])
  @@map("projects")
}

enum ProjectStatus {
  REQUIREMENT_CONFIRMED  // 需求已确认
  SCHEDULED             // 排期中
  IN_PRODUCTION         // 生产中
  DELIVERED_NOT_DEPLOYED // 交付未投产
  DELIVERED_DEPLOYED    // 交付已投产
}
```

#### project_developers - 项目开发者表

```prisma
model ProjectDeveloper {
  id        Int      @id @default(autoincrement())
  projectId Int
  userId    Int
  role      String?  @db.VarChar(50)  // 角色：开发、测试、产品等
  createdAt DateTime @default(now())

  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
  @@map("project_developers")
}
```

#### project_tags - 项目标签表

```prisma
model ProjectTag {
  id        Int      @id @default(autoincrement())
  projectId Int
  tagId     Int
  createdAt DateTime @default(now())

  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tag       Tag      @relation(fields: [tagId], references: [id])

  @@unique([projectId, tagId])
  @@index([projectId])
  @@index([tagId])
  @@map("project_tags")
}
```

#### project_impact - 项目影响数据表

```prisma
model ProjectImpact {
  id          Int      @id @default(autoincrement())
  projectId   Int      @unique
  efficiency  String?  @db.Text  // 效率提升描述
  costSaving  String?  @db.Text  // 成本节约描述
  replication String?  @db.Text  // 复用情况描述
  satisfaction String? @db.Text  // 满意度描述
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("project_impact")
}
```

#### project_replications - 项目复用记录表

```prisma
model ProjectReplication {
  id          Int      @id @default(autoincrement())
  projectId   Int
  replicatorId Int     // 复用者ID
  departmentId Int     // 复用部门ID
  status      ReplicationStatus @default(APPLIED)
  appliedAt   DateTime @default(now())
  deployedAt  DateTime?

  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  replicator  User     @relation(fields: [replicatorId], references: [id])
  department  Department @relation(fields: [departmentId], references: [id])

  @@index([projectId])
  @@index([replicatorId])
  @@index([departmentId])
  @@map("project_replications")
}

enum ReplicationStatus {
  APPLIED    // 已申请
  APPROVED   // 已批准
  DEPLOYED   // 已部署
}
```

### 4.5 互动相关表

#### comments - 评论表

```prisma
model Comment {
  id        Int      @id @default(autoincrement())
  projectId Int?     // 可为空，支持其他类型评论
  userId    Int
  content   String   @db.Text
  parentId  Int?     // 父评论ID（支持回复）
  likes     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project   Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])
  parent    Comment? @relation("CommentReplies", fields: [parentId], references: [id])
  replies   Comment[] @relation("CommentReplies")

  @@index([projectId])
  @@index([userId])
  @@index([parentId])
  @@index([createdAt])
  @@map("comments")
}
```

#### likes - 点赞表

```prisma
model Like {
  id        Int      @id @default(autoincrement())
  projectId Int?
  toolId    Int?
  demandId  Int?
  userId    Int
  createdAt DateTime @default(now())

  project   Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tool      Tool?    @relation(fields: [toolId], references: [id], onDelete: Cascade)
  demand    Demand?  @relation(fields: [demandId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@unique([projectId, userId])
  @@unique([toolId, userId])
  @@unique([demandId, userId])
  @@index([projectId])
  @@index([toolId])
  @@index([demandId])
  @@index([userId])
  @@map("likes")
}
```

#### follows - 关注表

```prisma
model Follow {
  id          Int      @id @default(autoincrement())
  followerId  Int
  followingId Int
  createdAt   DateTime @default(now())

  follower    User     @relation("Follower", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@map("follows")
}
```

### 4.6 通知相关表

#### notifications - 通知表

```prisma
model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int
  type      NotificationType
  title     String   @db.VarChar(200)
  content   String   @db.Text
  link      String?  @db.VarChar(500)
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

enum NotificationType {
  WELCOME           // 欢迎消息
  PROJECT_APPROVED  // 项目审核通过
  DEMAND_RESPONSE   // 需求有新响应
  COMMENT_REPLY     // 评论回复
  LIKE              // 点赞通知
  FOLLOW            // 关注通知
}
```

### 4.7 认证相关表

#### user_certifications - 用户认证表

```prisma
model UserCertification {
  id        Int      @id @default(autoincrement())
  userId    Int
  name      String   @db.VarChar(100)
  level     String   @db.VarChar(20)  // L1, L2, L3
  issuer    String   @db.VarChar(100) // 颁发机构
  icon      String?  @db.VarChar(500)
  issuedAt  DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_certifications")
}
```

## 5. 数据交互链路

### 5.1 工具广场交互链路

```
前端: ToolMarketplace
  ↓
API: GET /api/v1/tools
  ↓
后端: ToolsController.findAll()
  ↓
服务: ToolsService.findAll()
  ↓
数据库: 
  - tools (主表)
  - users (关联作者)
  - departments (关联部门)
  - tool_tags + tags (关联标签)
  - tool_reviews (计算评分)
  - tool_usages (统计使用人数)
```

### 5.2 需求广场交互链路

```
前端: DemandMarketplace
  ↓
API: GET /api/v1/demands
  ↓
后端: DemandsController.findAll()
  ↓
服务: DemandsService.findAll()
  ↓
数据库:
  - demands (主表)
  - users (关联发布者)
  - departments (关联部门)
  - discussions (讨论列表)
  - proposals (方案列表)
  - group_buys + group_buy_members (团购信息)
  - demand_followers (关注者)
```

### 5.3 项目广场交互链路

```
前端: ProjectShowcase
  ↓
API: GET /api/v1/projects
  ↓
后端: ProjectsController.findAll()
  ↓
服务: ProjectsService.findAll()
  ↓
数据库:
  - projects (主表)
  - departments (关联部门)
  - users (关联请求者、项目负责人)
  - project_developers (开发者列表)
  - project_tags + tags (标签)
  - project_impact (影响数据)
  - project_replications (复用记录)
  - likes (点赞数)
  - comments (评论数)
```

### 5.4 用户中心交互链路

```
前端: UserCenter
  ↓
API: GET /api/v1/users/:id
  ↓
后端: UsersController.findOne()
  ↓
服务: UsersService.findOne()
  ↓
数据库:
  - users (用户信息)
  - user_certifications (认证信息)
  - tools (创建的工具，统计)
  - demands (完成的需求，统计)
  - projects (参与的项目，统计)
  - likes (总点赞数，统计)
  - tool_reviews (平均评分，统计)
```

## 6. 索引优化策略

### 6.1 主键索引

所有表都有主键，自动创建主键索引。

### 6.2 外键索引

所有外键字段都创建索引，优化关联查询。

### 6.3 查询索引

根据常见查询场景创建索引：

- **工具表**: category, type, status, isFeatured, rating
- **需求表**: publisherId, status, category, isFeatured
- **项目表**: departmentId, category, status, isFeatured
- **用户表**: email, department, role

### 6.4 复合索引

```sql
-- 工具列表查询（分类+状态+是否精选）
CREATE INDEX idx_tools_category_status_featured 
ON tools(category, status, is_featured);

-- 项目列表查询（部门+状态+发布时间）
CREATE INDEX idx_projects_dept_status_time 
ON projects(department_id, status, publish_time DESC);
```

## 7. 数据完整性约束

### 7.1 外键约束

所有外键都设置 `onDelete: Cascade` 或 `onDelete: Restrict`，保证数据完整性。

### 7.2 唯一约束

- 用户邮箱唯一
- 工具名称+作者唯一（可选）
- 点赞记录唯一（同一用户对同一资源只能点赞一次）

### 7.3 检查约束

```sql
-- 评分范围检查
ALTER TABLE tool_reviews 
ADD CONSTRAINT chk_rating_range 
CHECK (rating >= 1 AND rating <= 5);

-- 价格非负检查
ALTER TABLE tools 
ADD CONSTRAINT chk_price_non_negative 
CHECK (price >= 0);
```

## 8. 数据迁移规范

### 8.1 Prisma Migration

```bash
# 创建迁移
npx prisma migrate dev --name add_user_table

# 应用迁移
npx prisma migrate deploy

# 重置数据库（开发环境）
npx prisma migrate reset
```

### 8.2 迁移文件命名

- 使用描述性名称: `20241118_add_user_table`
- 包含日期前缀
- 描述变更内容

## 9. 数据备份策略

### 9.1 备份频率

- 每日全量备份
- 每小时增量备份（生产环境）

### 9.2 备份保留

- 全量备份保留30天
- 增量备份保留7天

### 9.3 备份验证

- 每周恢复测试
- 备份完整性检查

## 10. 性能优化建议

### 10.1 查询优化

- 使用 `select` 只查询需要的字段
- 使用 `include` 预加载关联数据
- 避免 N+1 查询问题

### 10.2 分页优化

- 使用游标分页（Cursor-based）替代偏移分页（Offset-based）
- 限制每页最大数量（100条）

### 10.3 缓存策略

- 热门工具列表缓存（Redis，TTL: 5分钟）
- 用户信息缓存（Redis，TTL: 30分钟）
- 统计数据缓存（Redis，TTL: 1小时）

## 11. 检查清单

- [ ] 表结构设计完整
- [ ] 关系映射正确
- [ ] 索引优化到位
- [ ] 数据完整性约束
- [ ] 外键约束设置
- [ ] 唯一约束设置
- [ ] 数据迁移规范
- [ ] 备份策略制定
- [ ] 性能优化实施
- [ ] 缓存策略配置

---

**相关文档**:
- [API规范](./01-API规范.md)
- [数据库操作规范](./24-数据库操作规范.md)
- [性能优化规范](./13-性能优化规范.md)

