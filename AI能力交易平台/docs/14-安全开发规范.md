# 安全开发规范文档

> **版本**: v1.0.0  
> **最后更新**: 2024-11-18

## 1. 概述

本文档基于OWASP Top 10，定义了AI能力交易平台的安全开发规范。

## 2. OWASP Top 10防护

### 2.1 A01:2021 - 访问控制失效

#### 防护措施

```typescript
// 使用Guards进行权限控制
@Roles('admin')
@UseGuards(JwtAuthGuard, RolesGuard)
@Delete(':id')
async remove(@Param('id') id: number) {
  // 验证资源所有权
  const tool = await this.toolsService.findOne(id);
  if (tool.authorId !== currentUser.id && currentUser.role !== 'admin') {
    throw new ForbiddenException('无权删除此工具');
  }
  
  return this.toolsService.remove(id);
}
```

#### 检查清单

- [ ] 所有API都有权限验证
- [ ] 资源所有权验证
- [ ] 角色权限正确配置
- [ ] 敏感操作需要二次验证

### 2.2 A02:2021 - 加密失效

#### 密码加密

```typescript
import * as bcrypt from 'bcrypt';

// 密码哈希
const hashedPassword = await bcrypt.hash(password, 10);

// 密码验证
const isValid = await bcrypt.compare(password, hashedPassword);
```

#### 数据传输加密

- 所有API使用HTTPS
- 敏感数据加密传输
- 使用TLS 1.2+

#### 数据存储加密

```typescript
// 敏感字段加密存储
import * as crypto from 'crypto';

function encrypt(text: string): string {
  const cipher = crypto.createCipher('aes-256-cbc', secretKey);
  let encrypted = cipher.update(text, 'utf8', 'hex');
  encrypted += cipher.final('hex');
  return encrypted;
}
```

### 2.3 A03:2021 - 注入

#### SQL注入防护

使用Prisma参数化查询（自动防护）：

```typescript
// ✅ 安全：Prisma自动参数化
const tools = await prisma.tool.findMany({
  where: { name: { contains: searchQuery } },
});

// ❌ 危险：原始SQL（避免使用）
const tools = await prisma.$queryRaw`
  SELECT * FROM tools WHERE name LIKE '%${searchQuery}%'
`;
```

#### XSS防护

```typescript
// 后端：输出转义
import { escape } from 'html-escaper';

const safeContent = escape(userInput);

// 前端：React自动转义
<div>{userContent}</div> {/* React自动转义 */}
```

#### 命令注入防护

```typescript
// ❌ 危险
exec(`rm -rf ${userInput}`);

// ✅ 安全：使用参数化API
import { execFile } from 'child_process';
execFile('rm', ['-rf', userInput]);
```

### 2.4 A04:2021 - 不安全设计

#### 安全设计原则

- **最小权限**: 只授予必要权限
- **纵深防御**: 多层安全防护
- **失败安全**: 失败时拒绝访问
- **安全默认**: 默认安全配置

#### 威胁建模

- 识别潜在威胁
- 评估风险等级
- 制定防护措施
- 定期审查更新

### 2.5 A05:2021 - 安全配置错误

#### 安全配置检查清单

- [ ] 默认密码已修改
- [ ] 不必要的服务已禁用
- [ ] 错误信息不泄露敏感信息
- [ ] 安全头配置正确
- [ ] CORS配置合理

#### 安全头配置

```typescript
import helmet from 'helmet';

app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'"],
      scriptSrc: ["'self'"],
      imgSrc: ["'self'", "data:", "https:"],
    },
  },
  hsts: {
    maxAge: 31536000,
    includeSubDomains: true,
  },
}));
```

### 2.6 A06:2021 - 易受攻击的组件

#### 依赖管理

```bash
# 定期检查安全漏洞
npm audit

# 自动修复
npm audit fix

# 更新依赖
npm update
```

#### 组件选择

- 使用维护活跃的组件
- 检查组件安全记录
- 及时更新安全补丁

### 2.7 A07:2021 - 身份认证和会话管理失效

#### JWT安全配置

```typescript
// JWT配置
{
  secret: process.env.JWT_SECRET, // 强密钥
  expiresIn: '1h', // 合理过期时间
  algorithm: 'HS256',
}

// Refresh Token
{
  secret: process.env.JWT_REFRESH_SECRET,
  expiresIn: '7d',
}
```

#### 会话管理

- Token存储在HttpOnly Cookie（推荐）
- 或存储在localStorage（需XSS防护）
- 实现Token刷新机制
- 支持Token撤销

### 2.8 A08:2021 - 软件和数据完整性失效

#### 依赖完整性

```bash
# 使用package-lock.json锁定版本
npm ci

# 验证依赖完整性
npm audit
```

#### 代码完整性

- 使用Git签名提交
- 代码审查流程
- CI/CD安全检查

### 2.9 A09:2021 - 安全日志和监控失效

#### 日志记录

```typescript
// 记录安全事件
this.logger.warn('Failed login attempt', {
  email: userEmail,
  ip: request.ip,
  userAgent: request.headers['user-agent'],
});

// 不记录敏感信息
// ❌ this.logger.log('Password:', password);
```

#### 监控告警

- 异常登录检测
- 暴力破解检测
- 异常行为检测
- 实时告警通知

### 2.10 A10:2021 - 服务端请求伪造(SSRF)

#### SSRF防护

```typescript
// 验证URL
function isValidUrl(url: string): boolean {
  try {
    const parsed = new URL(url);
    // 禁止内网IP
    const blockedHosts = ['localhost', '127.0.0.1', '0.0.0.0'];
    if (blockedHosts.includes(parsed.hostname)) {
      return false;
    }
    // 禁止私有IP段
    if (parsed.hostname.match(/^(10\.|172\.(1[6-9]|2[0-9]|3[01])\.|192\.168\.)/)) {
      return false;
    }
    return true;
  } catch {
    return false;
  }
}
```

## 3. 输入验证

### 3.1 DTO验证

```typescript
import { IsString, IsEmail, MinLength, MaxLength } from 'class-validator';

export class CreateUserDto {
  @IsString()
  @MinLength(2)
  @MaxLength(100)
  name: string;

  @IsEmail()
  email: string;

  @IsString()
  @MinLength(8)
  @MaxLength(100)
  password: string;
}
```

### 3.2 文件上传验证

```typescript
// 文件类型验证
const allowedMimeTypes = ['image/jpeg', 'image/png', 'image/webp'];
if (!allowedMimeTypes.includes(file.mimetype)) {
  throw new BadRequestException('不支持的文件类型');
}

// 文件大小验证
const maxSize = 5 * 1024 * 1024; // 5MB
if (file.size > maxSize) {
  throw new BadRequestException('文件大小超过限制');
}
```

## 4. 速率限制

### 4.1 API速率限制

```typescript
import { ThrottlerModule, ThrottlerGuard } from '@nestjs/throttler';

@Module({
  imports: [
    ThrottlerModule.forRoot({
      ttl: 60,
      limit: 10, // 每分钟10次
    }),
  ],
})
export class AppModule {}

// 使用
@Throttle(5, 60) // 每分钟5次
@Post('login')
async login() {
  // ...
}
```

## 5. 敏感信息处理

### 5.1 密码处理

- 使用bcrypt哈希（cost factor ≥ 10）
- 不在日志中记录密码
- 不在错误信息中泄露密码

### 5.2 密钥管理

- 使用环境变量存储密钥
- 生产环境使用密钥管理服务
- 定期轮换密钥

### 5.3 数据脱敏

```typescript
// 手机号脱敏
function maskPhone(phone: string): string {
  return phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2');
}

// 邮箱脱敏
function maskEmail(email: string): string {
  const [name, domain] = email.split('@');
  return `${name.substring(0, 2)}***@${domain}`;
}
```

## 6. 安全检查清单

- [ ] 访问控制实现
- [ ] 加密配置正确
- [ ] 注入防护到位
- [ ] 安全设计遵循
- [ ] 配置安全正确
- [ ] 依赖安全更新
- [ ] 认证会话安全
- [ ] 数据完整性保证
- [ ] 日志监控完善
- [ ] SSRF防护实现
- [ ] 输入验证完善
- [ ] 速率限制配置
- [ ] 敏感信息保护

## 7. 安全审计

### 7.1 定期审计

- 每月安全扫描
- 每季度安全审计
- 每年渗透测试

### 7.2 安全培训

- 新员工安全培训
- 定期安全知识分享
- 安全事件复盘

---

**相关文档**:
- [风险内容红线规范](./04-风险内容红线规范.md)
- [API规范](./01-API规范.md)
- [日志与监控规范](./15-日志与监控规范.md)

