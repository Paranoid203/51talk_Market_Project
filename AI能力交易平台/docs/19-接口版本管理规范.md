# 接口版本管理规范文档

> **版本**: v1.0.0  
> **最后更新**: 2024-11-18

## 1. 概述

本文档定义了AI能力交易平台的API版本管理规范，包括版本策略、兼容性保证、废弃流程等。

## 2. 版本策略

### 2.1 URL版本控制（推荐）

```
/api/v1/tools
/api/v2/tools
```

#### 实现方式

```typescript
@Controller('v1/tools')
export class ToolsV1Controller {
  // v1版本实现
}

@Controller('v2/tools')
export class ToolsV2Controller {
  // v2版本实现
}
```

### 2.2 Header版本控制

```
GET /api/tools
Accept: application/vnd.api+json;version=1
```

### 2.3 版本选择

- **URL版本**: 简单直观，推荐使用
- **Header版本**: 更灵活，但实现复杂

## 3. 版本号规则

### 3.1 语义化版本

- **主版本（v1, v2）**: 不兼容的API变更
- **次版本（v1.1）**: 向后兼容的功能新增
- **补丁版本（v1.1.1）**: 向后兼容的问题修复

### 3.2 版本变更规则

#### 主版本升级（v1 → v2）

触发条件：
- 请求/响应格式变更
- 资源结构变更
- 认证方式变更
- 删除必需参数

#### 次版本升级（v1.0 → v1.1）

触发条件：
- 新增可选参数
- 新增响应字段
- 新增端点

#### 补丁版本升级（v1.1.0 → v1.1.1）

触发条件：
- Bug修复
- 文档更新
- 性能优化

## 4. 向后兼容性

### 4.1 兼容性原则

- **新增字段**: 必须可选
- **删除字段**: 先标记废弃，下个主版本删除
- **修改字段**: 视为不兼容变更
- **新增端点**: 兼容
- **删除端点**: 不兼容

### 4.2 兼容性示例

```typescript
// v1版本
interface CreateToolDto {
  name: string;
  description: string;
  category: string;
}

// v1.1版本（兼容）
interface CreateToolDto {
  name: string;
  description: string;
  category: string;
  tags?: string[]; // 新增可选字段 ✅
}

// v2版本（不兼容）
interface CreateToolDto {
  title: string; // 字段名变更 ❌
  description: string;
  category: string;
}
```

## 5. 废弃流程

### 5.1 废弃标记

```typescript
/**
 * @deprecated 此接口将在v2版本中移除，请使用 GET /api/v2/tools
 */
@Get()
@Deprecated()
async findAll() {
  // ...
}
```

### 5.2 废弃响应头

```typescript
@Get()
@Header('X-API-Deprecation', 'true')
@Header('X-API-Sunset', '2025-06-01')
async deprecatedEndpoint() {
  // ...
}
```

### 5.3 废弃时间表

1. **标记废弃**: 在文档和代码中标记
2. **通知用户**: 邮件/公告通知
3. **保留周期**: 至少保留2个版本周期（6个月）
4. **移除**: 在新主版本中移除

## 6. 版本迁移指南

### 6.1 迁移文档

为每个主版本升级提供迁移指南：

```markdown
# API v1 到 v2 迁移指南

## 变更概述
- 工具名称字段从 `name` 改为 `title`
- 新增 `metadata` 字段

## 迁移步骤
1. 更新API端点：`/api/v1/tools` → `/api/v2/tools`
2. 更新字段名：`name` → `title`
3. 处理新字段：`metadata`

## 代码示例
// v1
const tool = await api.get('/api/v1/tools/1');
console.log(tool.name);

// v2
const tool = await api.get('/api/v2/tools/1');
console.log(tool.title);
```

## 7. 版本测试

### 7.1 兼容性测试

- 测试旧版本客户端仍能工作
- 测试新版本功能正常
- 测试版本切换平滑

### 7.2 回归测试

- 所有版本都要有测试覆盖
- 版本升级前充分测试
- 保持测试用例更新

## 8. 版本文档

### 8.1 API文档版本化

- Swagger文档按版本组织
- 每个版本独立文档
- 标注版本差异

### 8.2 变更日志

```markdown
## [2.0.0] - 2024-12-01

### Breaking Changes
- 工具名称字段从 `name` 改为 `title`
- 删除 `legacyField` 字段

### Added
- 新增 `metadata` 字段
- 新增批量操作接口

### Deprecated
- `GET /api/v1/tools` 将在2025-06-01移除
```

## 9. 客户端适配

### 9.1 版本协商

```typescript
// 客户端指定支持的版本
const apiClient = axios.create({
  baseURL: 'https://api.example.com',
  headers: {
    'Accept': 'application/vnd.api+json;version=1',
  },
});
```

### 9.2 降级策略

- 支持多版本客户端
- 自动降级到兼容版本
- 版本不支持时明确错误

## 10. 检查清单

- [ ] 版本策略明确
- [ ] 版本号规则统一
- [ ] 兼容性保证
- [ ] 废弃流程规范
- [ ] 迁移指南完善
- [ ] 版本测试充分
- [ ] 文档版本化
- [ ] 客户端适配

---

**相关文档**:
- [API规范](./01-API规范.md)
- [文档编写规范](./12-文档编写规范.md)

