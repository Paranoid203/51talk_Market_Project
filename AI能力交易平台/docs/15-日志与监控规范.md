# 日志与监控规范文档

> **版本**: v1.0.0  
> **最后更新**: 2024-11-18

## 1. 概述

本文档定义了AI能力交易平台的日志记录和监控规范，包括日志级别、格式、错误追踪、性能监控等。

## 2. 日志级别

### 2.1 日志级别定义

| 级别 | 用途 | 示例 |
|------|------|------|
| DEBUG | 调试信息 | 函数调用参数、中间状态 |
| INFO | 一般信息 | 用户操作、业务流程 |
| WARN | 警告信息 | 异常但可恢复的情况 |
| ERROR | 错误信息 | 错误但系统可继续运行 |
| FATAL | 致命错误 | 系统无法继续运行 |

### 2.2 日志级别使用

```typescript
// DEBUG: 详细的调试信息
this.logger.debug(`Processing tool creation: ${JSON.stringify(dto)}`);

// INFO: 一般业务流程
this.logger.log(`Tool created: ${tool.id} by user ${userId}`);

// WARN: 警告但不影响功能
this.logger.warn(`Slow query detected: ${queryTime}ms`);

// ERROR: 错误但可恢复
this.logger.error(`Failed to send email: ${error.message}`, error.stack);

// FATAL: 致命错误
this.logger.fatal(`Database connection lost`, error.stack);
```

## 3. 日志格式

### 3.1 结构化日志

```typescript
// 使用结构化日志
this.logger.log({
  level: 'info',
  message: 'Tool created',
  toolId: tool.id,
  userId: userId,
  timestamp: new Date().toISOString(),
  requestId: request.id,
});
```

### 3.2 日志格式标准

```json
{
  "timestamp": "2024-11-18T10:00:00.000Z",
  "level": "info",
  "message": "Tool created",
  "context": "ToolsService",
  "requestId": "550e8400-e29b-41d4-a716-446655440000",
  "userId": 123,
  "toolId": 456,
  "duration": 45
}
```

## 4. 日志内容规范

### 4.1 必须记录的信息

- 用户操作（创建、更新、删除）
- 错误和异常
- 性能指标（响应时间、查询时间）
- 安全事件（登录失败、权限拒绝）

### 4.2 禁止记录的信息

- 密码、密钥
- 完整信用卡号
- 完整身份证号
- 其他敏感个人信息

### 4.3 日志示例

```typescript
// ✅ 正确：记录必要信息
this.logger.log(`User ${userId} created tool ${toolId}`);

// ❌ 错误：记录敏感信息
this.logger.log(`User login: email=${email}, password=${password}`);

// ✅ 正确：脱敏处理
this.logger.log(`User login attempt: email=${maskEmail(email)}`);
```

## 5. 错误追踪

### 5.1 Sentry集成

```typescript
import * as Sentry from '@sentry/node';

Sentry.init({
  dsn: process.env.SENTRY_DSN,
  environment: process.env.NODE_ENV,
  tracesSampleRate: 1.0,
});

// 捕获异常
try {
  // ...
} catch (error) {
  Sentry.captureException(error);
  throw error;
}
```

### 5.2 错误上下文

```typescript
Sentry.configureScope((scope) => {
  scope.setUser({ id: userId, email: userEmail });
  scope.setTag('operation', 'createTool');
  scope.setContext('tool', { id: toolId, name: toolName });
});
```

## 6. 性能监控

### 6.1 API性能监控

```typescript
@Injectable()
export class LoggingInterceptor implements NestInterceptor {
  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
    const request = context.switchToHttp().getRequest();
    const { method, url } = request;
    const now = Date.now();

    return next.handle().pipe(
      tap(() => {
        const responseTime = Date.now() - now;
        
        this.logger.log({
          method,
          url,
          responseTime,
          statusCode: context.switchToHttp().getResponse().statusCode,
        });

        // 慢请求告警
        if (responseTime > 1000) {
          this.logger.warn(`Slow request: ${method} ${url} took ${responseTime}ms`);
        }
      }),
      catchError((error) => {
        const responseTime = Date.now() - now;
        this.logger.error({
          method,
          url,
          responseTime,
          error: error.message,
        });
        throw error;
      }),
    );
  }
}
```

### 6.2 数据库性能监控

```typescript
// Prisma查询日志
const prisma = new PrismaClient({
  log: [
    { emit: 'event', level: 'query' },
    { emit: 'event', level: 'error' },
  ],
});

prisma.$on('query', (e) => {
  if (e.duration > 100) {
    logger.warn(`Slow query: ${e.query} took ${e.duration}ms`);
  }
});
```

## 7. 业务指标监控

### 7.1 关键指标

- 用户注册数
- 工具创建数
- 需求发布数
- 项目创建数
- API调用量
- 错误率

### 7.2 指标记录

```typescript
// 使用Metrics服务
@Injectable()
export class MetricsService {
  incrementCounter(metric: string, tags?: Record<string, string>) {
    // 记录指标
    this.logger.log({
      type: 'metric',
      metric,
      value: 1,
      tags,
    });
  }

  recordTiming(metric: string, duration: number) {
    this.logger.log({
      type: 'timing',
      metric,
      value: duration,
    });
  }
}
```

## 8. 日志存储

### 8.1 日志文件

- **开发环境**: 控制台输出
- **测试环境**: 文件 + 控制台
- **生产环境**: 文件 + 日志服务（ELK/CloudWatch）

### 8.2 日志轮转

```typescript
// 使用winston进行日志轮转
import * as winston from 'winston';
import 'winston-daily-rotate-file';

const logger = winston.createLogger({
  transports: [
    new winston.transports.DailyRotateFile({
      filename: 'logs/app-%DATE%.log',
      datePattern: 'YYYY-MM-DD',
      maxSize: '20m',
      maxFiles: '14d',
    }),
  ],
});
```

## 9. 告警规则

### 9.1 错误告警

- **错误率**: > 1% 告警
- **致命错误**: 立即告警
- **连续错误**: 5分钟内>10次告警

### 9.2 性能告警

- **响应时间**: P95 > 500ms 告警
- **慢查询**: > 1s 告警
- **CPU使用率**: > 80% 告警
- **内存使用率**: > 85% 告警

### 9.3 业务告警

- **API调用量异常**: 突然下降或激增
- **用户注册异常**: 异常波动
- **支付异常**: 失败率>5%

## 10. 监控工具

### 10.1 应用性能监控（APM）

- **工具**: New Relic / Datadog / 阿里云ARMS
- **指标**: 响应时间、吞吐量、错误率
- **追踪**: 分布式追踪

### 10.2 日志聚合

- **工具**: ELK Stack / Splunk / 阿里云SLS
- **功能**: 日志收集、搜索、分析

### 10.3 错误追踪

- **工具**: Sentry / Bugsnag
- **功能**: 错误捕获、堆栈追踪、告警

## 11. 检查清单

- [ ] 日志级别规范
- [ ] 日志格式统一
- [ ] 敏感信息过滤
- [ ] 错误追踪配置
- [ ] 性能监控实施
- [ ] 业务指标监控
- [ ] 日志存储配置
- [ ] 告警规则设置
- [ ] 监控工具集成

---

**相关文档**:
- [后端代码规范](./03-后端代码规范.md)
- [性能优化规范](./13-性能优化规范.md)
- [安全开发规范](./14-安全开发规范.md)

