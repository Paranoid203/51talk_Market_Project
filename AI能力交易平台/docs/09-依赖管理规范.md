# 依赖管理规范文档

> **版本**: v1.0.0  
> **最后更新**: 2024-11-18

## 1. 概述

本文档定义了AI能力交易平台的依赖管理规范，包括版本锁定策略、依赖更新流程、安全漏洞扫描等。

## 2. 版本锁定策略

### 2.1 版本号格式

使用语义化版本号（Semantic Versioning）:

```
主版本号.次版本号.修订号
MAJOR.MINOR.PATCH
```

- **MAJOR**: 不兼容的API变更
- **MINOR**: 向后兼容的功能新增
- **PATCH**: 向后兼容的问题修复

### 2.2 版本范围策略

#### 精确版本（推荐生产依赖）

```json
{
  "dependencies": {
    "react": "18.3.1",
    "react-dom": "18.3.1"
  }
}
```

#### 兼容版本（开发依赖）

```json
{
  "devDependencies": {
    "@types/node": "^20.10.0",
    "typescript": "~5.6.3"
  }
}
```

- `^`: 允许次版本和修订版本更新
- `~`: 只允许修订版本更新
- `*`: 允许所有版本（不推荐）

### 2.3 package-lock.json

- **必须提交**: `package-lock.json` 必须提交到Git
- **锁定版本**: 确保团队使用相同版本
- **CI/CD**: 使用 `npm ci` 安装（更快、更可靠）

## 3. 依赖分类

### 3.1 dependencies（生产依赖）

运行时必需的依赖：

```json
{
  "dependencies": {
    "react": "18.3.1",
    "react-dom": "18.3.1",
    "@nestjs/common": "^10.0.0",
    "prisma": "^5.0.0"
  }
}
```

### 3.2 devDependencies（开发依赖）

仅开发时需要的依赖：

```json
{
  "devDependencies": {
    "@types/react": "^18.3.12",
    "typescript": "^5.6.3",
    "eslint": "^8.0.0",
    "prettier": "^3.0.0"
  }
}
```

### 3.3 peerDependencies（对等依赖）

需要宿主环境提供的依赖：

```json
{
  "peerDependencies": {
    "react": ">=18.0.0"
  }
}
```

## 4. 依赖更新流程

### 4.1 更新检查

```bash
# 检查过时的依赖
npm outdated

# 检查安全漏洞
npm audit
```

### 4.2 更新策略

#### 安全更新（立即）

- 安全漏洞修复立即更新
- 使用 `npm audit fix`

#### 补丁更新（定期）

- 每月检查补丁更新
- 测试后更新

#### 次版本更新（谨慎）

- 评估新功能需求
- 充分测试后更新

#### 主版本更新（重大）

- 需要团队评审
- 制定迁移计划
- 充分测试

### 4.3 更新步骤

1. **创建分支**: `git checkout -b chore/update-dependencies`
2. **更新依赖**: `npm update` 或手动更新
3. **运行测试**: `npm test`
4. **检查构建**: `npm run build`
5. **提交变更**: 遵循提交规范
6. **创建PR**: 代码审查后合并

## 5. 安全漏洞扫描

### 5.1 npm audit

```bash
# 检查漏洞
npm audit

# 自动修复
npm audit fix

# 强制修复（可能破坏兼容性）
npm audit fix --force
```

### 5.2 漏洞处理流程

1. **发现漏洞**: `npm audit` 检测
2. **评估风险**: 查看漏洞详情
3. **更新依赖**: 更新到安全版本
4. **测试验证**: 确保功能正常
5. **部署修复**: 及时部署到生产

### 5.3 漏洞等级

- **Critical**: 立即修复
- **High**: 尽快修复
- **Moderate**: 计划修复
- **Low**: 评估后修复

## 6. 依赖选择标准

### 6.1 选择原则

- **维护活跃**: 最近6个月有更新
- **社区支持**: 有足够的Star和Issue
- **文档完善**: 有清晰的文档
- **类型支持**: 有TypeScript类型定义
- **许可证**: 符合项目许可证要求

### 6.2 避免的依赖

- 已停止维护的包
- 安全漏洞未修复的包
- 许可证不兼容的包
- 功能重复的包

## 7. 依赖审查

### 7.1 新增依赖审查

添加新依赖前需要：

1. **评估必要性**: 是否真的需要
2. **检查替代方案**: 是否有更好的选择
3. **评估风险**: 安全性和维护性
4. **团队讨论**: 重大依赖需要团队同意

### 7.2 依赖清理

定期清理未使用的依赖：

```bash
# 检查未使用的依赖
npx depcheck

# 移除未使用的依赖
npm uninstall <package>
```

## 8. 锁定文件管理

### 8.1 package-lock.json

- **必须提交**: 确保版本一致性
- **不要手动编辑**: 由npm自动管理
- **冲突解决**: 删除后重新生成

### 8.2 yarn.lock（如使用Yarn）

- 与 `package-lock.json` 二选一
- 团队统一使用一种

## 9. 私有依赖

### 9.1 私有NPM仓库

```bash
# 配置私有仓库
npm config set @company:registry https://npm.company.com

# 安装私有包
npm install @company/package-name
```

### 9.2 认证配置

- 使用 `.npmrc` 配置认证
- 不提交敏感信息到Git
- CI/CD使用环境变量

## 10. 最佳实践

### 10.1 依赖最小化

- 只安装必需的依赖
- 定期清理未使用的依赖
- 避免功能重复的依赖

### 10.2 版本管理

- 生产依赖使用精确版本
- 开发依赖可以使用范围版本
- 定期更新依赖

### 10.3 安全优先

- 及时修复安全漏洞
- 使用安全扫描工具
- 关注依赖安全公告

## 11. 检查清单

- [ ] 版本锁定策略明确
- [ ] package-lock.json提交
- [ ] 依赖分类正确
- [ ] 更新流程规范
- [ ] 安全扫描配置
- [ ] 漏洞处理流程
- [ ] 依赖审查机制
- [ ] 定期清理未使用依赖

---

**相关文档**:
- [安全开发规范](./14-安全开发规范.md)
- [Git工作流规范](./07-Git工作流规范.md)

