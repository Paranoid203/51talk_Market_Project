# 数据管理规范文档

> **版本**: v1.0.0  
> **最后更新**: 2024-11-18

## 1. 概述

本文档定义了AI能力交易平台的数据管理规范，包括数据备份、迁移、清理、归档和权限控制。

## 2. 数据备份策略

### 2.1 备份类型

#### 全量备份

- **频率**: 每日一次
- **时间**: 凌晨2:00（低峰期）
- **保留**: 30天
- **存储**: 本地 + 异地

#### 增量备份

- **频率**: 每小时一次
- **保留**: 7天
- **存储**: 本地

### 2.2 备份脚本

```bash
#!/bin/bash
# backup.sh

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backups"
DB_NAME="ai_platform"

# 全量备份
pg_dump -U postgres -d $DB_NAME -F c -f $BACKUP_DIR/full_$DATE.dump

# 压缩备份
gzip $BACKUP_DIR/full_$DATE.dump

# 删除30天前的备份
find $BACKUP_DIR -name "full_*.dump.gz" -mtime +30 -delete
```

### 2.3 备份验证

- 每周恢复测试
- 验证备份完整性
- 记录备份日志

## 3. 数据迁移规范

### 3.1 Prisma Migration

```bash
# 创建迁移
npx prisma migrate dev --name add_user_level

# 应用迁移（生产环境）
npx prisma migrate deploy

# 回滚迁移（开发环境）
npx prisma migrate reset
```

### 3.2 迁移文件规范

```prisma
// migrations/20241118_add_user_level/migration.sql
ALTER TABLE users ADD COLUMN level INT DEFAULT 1;
ALTER TABLE users ADD COLUMN level_name VARCHAR(50) DEFAULT '新手';
```

### 3.3 迁移检查清单

- [ ] 迁移脚本测试通过
- [ ] 数据迁移脚本准备
- [ ] 回滚方案准备
- [ ] 备份数据完成
- [ ] 迁移时间窗口确定
- [ ] 团队通知完成

## 4. 数据清理策略

### 4.1 清理规则

#### 软删除数据

- 用户删除：标记为删除，保留30天
- 工具删除：标记为删除，保留90天
- 需求删除：标记为删除，保留30天

#### 硬删除数据

- 过期Token：7天后删除
- 临时文件：24小时后删除
- 日志文件：按保留策略删除

### 4.2 清理脚本

```typescript
@Injectable()
export class DataCleanupService {
  @Cron('0 2 * * *') // 每天凌晨2点
  async cleanupDeletedUsers() {
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

    await this.prisma.user.deleteMany({
      where: {
        deletedAt: {
          lt: thirtyDaysAgo,
        },
      },
    });
  }
}
```

## 5. 数据归档规范

### 5.1 归档策略

#### 归档条件

- 数据超过1年未访问
- 数据状态为已完成/已关闭
- 数据量超过阈值

#### 归档流程

1. 标记归档数据
2. 导出到归档存储
3. 从主数据库删除
4. 记录归档日志

### 5.2 归档存储

- **格式**: CSV / JSON
- **存储**: 对象存储（OSS/S3）
- **索引**: 归档索引表

## 6. 数据权限控制

### 6.1 行级权限

```typescript
// 用户只能访问自己的数据
async findUserTools(userId: number) {
  return this.prisma.tool.findMany({
    where: { authorId: userId },
  });
}

// 部门数据隔离
async findDepartmentTools(departmentId: number, userId: number) {
  const user = await this.prisma.user.findUnique({ where: { id: userId } });
  
  if (user.departmentId !== departmentId && user.role !== 'admin') {
    throw new ForbiddenException('无权访问其他部门数据');
  }
  
  return this.prisma.tool.findMany({
    where: { departmentId },
  });
}
```

### 6.2 字段级权限

```typescript
// 根据角色返回不同字段
function sanitizeUser(user: User, requester: User) {
  if (requester.id === user.id || requester.role === 'admin') {
    return user; // 返回完整信息
  }
  
  // 返回公开信息
  return {
    id: user.id,
    name: user.name,
    department: user.department,
    // 不返回email、phone等敏感信息
  };
}
```

## 7. 敏感数据脱敏

### 7.1 脱敏规则

```typescript
// 手机号脱敏
function maskPhone(phone: string): string {
  return phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2');
}

// 邮箱脱敏
function maskEmail(email: string): string {
  const [name, domain] = email.split('@');
  return `${name.substring(0, 2)}***@${domain}`;
}

// 身份证脱敏
function maskIdCard(idCard: string): string {
  return idCard.replace(/(\d{6})\d{8}(\d{4})/, '$1********$2');
}
```

### 7.2 脱敏使用

```typescript
// 列表接口返回脱敏数据
async findAll(): Promise<User[]> {
  const users = await this.prisma.user.findMany();
  return users.map(user => ({
    ...user,
    email: maskEmail(user.email),
    phone: maskPhone(user.phone),
  }));
}
```

## 8. 数据导出规范

### 8.1 导出权限

- 普通用户：只能导出自己的数据
- 部门管理员：可以导出部门数据
- 平台管理员：可以导出所有数据

### 8.2 导出格式

- **CSV**: 用于数据分析
- **JSON**: 用于数据迁移
- **Excel**: 用于报表

### 8.3 导出限制

- 单次导出最多10000条
- 需要审核（超过1000条）
- 记录导出日志

## 9. 数据恢复流程

### 9.1 恢复场景

- 数据误删除
- 数据损坏
- 系统故障

### 9.2 恢复流程

1. **停止服务**: 防止新数据写入
2. **选择备份**: 选择最近的备份
3. **恢复数据**: 执行恢复操作
4. **验证数据**: 验证数据完整性
5. **恢复服务**: 恢复服务运行
6. **记录日志**: 记录恢复过程

## 10. 数据合规

### 10.1 数据保留期限

- **用户数据**: 账户注销后保留30天
- **操作日志**: 保留1年
- **业务数据**: 按业务需求保留

### 10.2 数据删除请求

- 用户有权请求删除数据
- 30天内处理删除请求
- 记录删除操作日志

## 11. 检查清单

- [ ] 备份策略制定
- [ ] 备份脚本配置
- [ ] 迁移流程规范
- [ ] 清理策略实施
- [ ] 归档流程规范
- [ ] 权限控制完善
- [ ] 数据脱敏实施
- [ ] 导出规范制定
- [ ] 恢复流程准备
- [ ] 合规要求满足

---

**相关文档**:
- [数据库规范](./06-数据库规范.md)
- [数据库操作规范](./24-数据库操作规范.md)
- [风险内容红线规范](./04-风险内容红线规范.md)

